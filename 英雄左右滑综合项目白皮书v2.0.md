# ã€ŠPath of Kingsã€‹å¤åˆ»ç‰ˆ - ç»¼åˆé¡¹ç›®ç™½çš®ä¹¦ v2.0

## ç¬¬ä¸€éƒ¨åˆ†ï¼šäº§å“éœ€æ±‚æ–‡æ¡£ (PRD) & æ¸¸æˆç­–åˆ’

### 1.1 æ¸¸æˆæµç¨‹æ¶æ„ (Game Flow)

åŸºäºæˆªå›¾åˆ†æï¼Œæ¸¸æˆçš„å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š

1. **ä¸»ç•Œé¢ (Main UI):** åº•éƒ¨ä¸‰ä¸ªæ ¸å¿ƒå…¥å£ã€‚
2. **å†’é™©å‡†å¤‡:** åœ¨â€œå†’é™©â€é¡µç­¾é€‰æ‹©ç« èŠ‚ï¼ˆå¦‚ Chapter 2: Frostwood Riseï¼‰ã€‚
3. **è·¯çº¿è§„åˆ’ (Map Phase):** è¿›å…¥èŠ‚ç‚¹å¼åœ°å›¾ï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªå‰è¿›æ–¹å‘ã€‚
4. å±€å†…å¾ªç¯:
   - **æˆ˜æ–—èŠ‚ç‚¹ (Chest):** è‡ªåŠ¨æˆ˜æ–— -> æ‰è½è£…å¤‡ -> å·¦å³æ»‘å†³ç­–ã€‚
   - **å¥‡é‡èŠ‚ç‚¹:** æ³‰æ°´ï¼ˆé€‰æŠ€èƒ½ï¼‰ã€çº¢å¿ƒï¼ˆå›è¡€ï¼‰ã€‚
5. **ç»“ç®—:** èƒœåˆ©/å¤±è´¥ï¼Œç»“ç®—é‡‘å¸ï¼Œå›åˆ°ä¸»ç•Œé¢è¿›è¡Œå±æ€§å‡çº§ã€‚

### 1.2 æ ¸å¿ƒç•Œé¢åŠŸèƒ½è¯¦è§£

### A. ä¸»ç•Œé¢ä¸ä¸‰å¤§å…¥å£ (Bottom Navigation)

å¯¹åº”æˆªå›¾ [Image 2], [Image 6]

åº•æ åŒ…å«ä¸‰ä¸ªå›¾æ ‡ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ä¸ªæ ¸å¿ƒç³»ç»Ÿï¼š

1. å·¦ä¾§ - èƒŒåŒ… (Backpack/Inventory)

   - æŸ¥çœ‹å½“å‰ç©¿æˆ´çš„è£…å¤‡ã€‚
   - æŸ¥çœ‹å·²æ”¶é›†çš„è£…å¤‡å›¾é‰´ï¼ˆå¦‚æœ‰ï¼‰ã€‚

2. ä¸­é—´ - å†’é™© (Adventure)

   - **ç« èŠ‚é€‰æ‹©:** å·¦å³åˆ‡æ¢é€‰æ‹©åœ°å›¾ï¼ˆå¦‚ Frostwood Riseï¼‰ã€‚
   - **æ‰è½é¢„è§ˆ:** æ˜¾ç¤ºæœ¬å…³å¡æ‰è½è£…å¤‡çš„å“è´¨æ¦‚ç‡ï¼ˆä¾‹å¦‚ï¼šç™½è£… 80%, ç»¿è£… 19%, è“è£… 1%ï¼‰ã€‚
   - **è¿›åº¦é¢„è§ˆ:** æ˜¾ç¤ºå…³å¡é•¿åº¦ï¼ˆèŠ‚ç‚¹æ•°ï¼‰ã€‚
   - **å…¥å£æŒ‰é’®:** "ENTER LEVEL X"ã€‚

3. å³ä¾§ - é­”æ³•ä¹¦ (Stats & Upgrade)

   - **å±æ€§é¢æ¿:** æ˜¾ç¤ºè§’è‰²çš„10é¡¹æ ¸å¿ƒå±æ€§æ€»å€¼ã€‚

   - å‡çº§æœºåˆ¶ (æ ¸å¿ƒ):

      \* ç‚¹å‡» "UPGRADE" æŒ‰é’®ï¼ˆæ¶ˆè€—é‡‘å¸ï¼Œå¦‚ 250 Goldï¼‰ã€‚

     - **äº¤äº’:** ç³»ç»ŸéšæœºæŠ½å– 2 é¡¹å±æ€§æå‡é€‰é¡¹ï¼ˆä¾‹å¦‚ï¼šâ€œæ”»å‡»+5â€ vs â€œæš´å‡»+2%â€ï¼‰ã€‚
     - **å†³ç­–:** å¼¹å‡ºå¡ç‰‡ï¼Œç©å®¶**å·¦æ»‘/å³æ»‘**ä¿ç•™å…¶ä¸­ä¸€é¡¹ï¼Œæ”¾å¼ƒå¦ä¸€é¡¹ã€‚è¿™æ˜¯ä¸ºäº†ä¿æŒå…¨æ¸¸æˆäº¤äº’é€»è¾‘çš„ä¸€è‡´æ€§ã€‚

### B. å±€å¤–æˆé•¿ï¼š10ç»´å±æ€§ç³»ç»Ÿ (Stats System)

å¯¹åº”æˆªå›¾ [Image 6], [Image 7]

è¿™æ˜¯æ¸¸æˆçš„åº•å±‚æ•°å€¼æ¡†æ¶ï¼Œæ‰€æœ‰è£…å¤‡å’ŒæŠ€èƒ½éƒ½å›´ç»•è¿™10ä¸ªå±æ€§å±•å¼€ï¼š

| **å›¾æ ‡** | **å±æ€§å (EN)**  | **å±æ€§å (CN)** | **æ¸¸æˆå†…æè¿° (Description)**           | **å¤‡æ³¨** |
| -------- | ---------------- | --------------- | -------------------------------------- | -------- |
| âš”ï¸        | **Damage**       | æ”»å‡»åŠ›          | Increases how much damage you deal     | åŸºç¡€ä¼¤å®³ |
| â¤ï¸        | **Health**       | ç”Ÿå‘½å€¼          | Increases how much health you have     | ç”Ÿå­˜åŸºç¡€ |
| ğŸ’¨        | **Attack Speed** | æ”»é€Ÿ            | Increases how fast you attack          | æ”»å‡»é¢‘ç‡ |
| ğŸ›¡ï¸        | **Armor**        | æŠ¤ç”²            | Reduces incoming damage and bleed      | å‡ä¼¤æœºåˆ¶ |
| ğŸ’¥        | **Crit**         | æš´å‡»            | Increases chance to deal double damage | çˆ†å‘æ‰‹æ®µ |
| ğŸ’ª        | **Toughness**    | éŸ§æ€§            | Reduces chance of taking crits         | é˜²çˆ†å‡»   |
| ğŸ‘        | **Dodge**        | é—ªé¿            | Increases chance to avoid damage       | å…ä¼¤æ¦‚ç‡ |
| ğŸ¯        | **Accuracy**     | å‘½ä¸­            | Lowers the enemy's chance to dodge     | å¯¹æŠ—é—ªé¿ |
| ğŸ©¸â¤ï¸       | **Lifesteal**    | å¸è¡€            | Restores health when dealing damage    | ç»­èˆª     |
| ğŸ©¸        | **Bleed**        | æµè¡€            | Applies damage over time               | DOTä¼¤å®³  |

### C. é—¯å…³ï¼šåœ°å›¾ä¸èŠ‚ç‚¹ç³»ç»Ÿ (Map System)

å¯¹åº”æˆªå›¾ [Image 1], [Image 4]

å…³å¡é‡‡ç”¨èŠ‚ç‚¹åˆ†æ”¯ç»“æ„ï¼Œç©å®¶éœ€è¦æ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©è·¯çº¿ã€‚

- **UIè¡¨ç°:** å·è½´å¼åœ°å›¾ï¼Œè‡ªä¸‹è€Œä¸Šæ¨è¿›ã€‚
- èŠ‚ç‚¹ç±»å‹:
  - **Start (æ——å¸œ):** èµ·ç‚¹ã€‚
  - **Enemy (äººç‰©/æ€ªç‰©å¤´):** æ™®é€šæˆ˜æ–—ï¼Œæ— ç‰¹æ®Šå¥–åŠ±ã€‚
  - **Chest (æœ¨ç®±/ç»¿ç®±):** **æˆ˜æ–—èŠ‚ç‚¹**ã€‚å‡»è´¥æ•Œäººåå¿…å®šè¿›å…¥â€œå¼€å®ç®±/é€‰è£…å¤‡â€ç¯èŠ‚ã€‚
  - **Elite Chest (é‡‘ç®±):** ç²¾è‹±æˆ˜æ–—ï¼Œæ‰è½é«˜å“è´¨è£…å¤‡ã€‚
  - **Fountain (è“æ³‰æ°´):** **æŠ€èƒ½å‡çº§**ã€‚è§¦å‘â€œä¸‰é€‰ä¸€â€æŠ€èƒ½å¡ç‰Œã€‚
  - **Heart (çº¢å¿ƒ):** **æ¢å¤**ã€‚ç›´æ¥æ¢å¤ä¸€å®šæ¯”ä¾‹ï¼ˆå¦‚ 30%-50%ï¼‰çš„ HPã€‚

### D. å±€å†…ï¼šè£…å¤‡æ§½ä½ (Equipment Slots)

å¯¹åº”æˆªå›¾ [Image 5]

ç•Œé¢ä¸‹æ–¹æœ‰ 8ä¸ª å›ºå®šçš„è£…å¤‡æ§½ä½ã€‚è¿™æ„å‘³ç€ç©å®¶éœ€è¦å‡‘é½ä¸€å¥—Buildã€‚

- æ§½ä½æ¨æµ‹:
  1. **Weapon (ä¸»æ‰‹):** å‰‘ã€æ–§ã€é”¤ã€‚
  2. **Armor (èº«ä½“):** è¡£æœã€æ¿ç”²ã€‚
  3. **Helmet (å¤´éƒ¨):** å¤´ç›”ã€‚
  4. **Boots (è„šéƒ¨):** é‹å­ã€‚
  5. **Accessory 1 (é¥°å“):** é¡¹é“¾/å‹‹ç« ã€‚
  6. **Accessory 2 (æˆ’æŒ‡):** æˆ’æŒ‡ã€‚
  7. **Offhand/Pet (å‰¯æ‰‹/å® ç‰©):** æˆªå›¾ä¸­æœ‰ä¸€åªè€é¼ æ‹¿ç€ä¹¦ (Mouse)ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å® ç‰©æˆ–å‰¯æ‰‹æ§½ä½ã€‚
  8. **Special (ç‰¹æ®Š):** æˆªå›¾ä¸­è¿˜æœ‰ä¸€ä¸ªå¤´ç›”çŠ¶å›¾æ ‡ï¼Œå¯èƒ½æ˜¯å¤‡ç”¨è£…å¤‡æ æˆ–æŠ¤è…¿ã€‚

### E. å±€å†…ï¼šæŠ€èƒ½é€‰æ‹© (Ability Draft)

å¯¹åº”æˆªå›¾ [Image 3]

åœ¨ç»è¿‡â€œæ³‰æ°´â€èŠ‚ç‚¹æˆ–å‡çº§æ—¶è§¦å‘ã€‚

- **äº¤äº’:** ä¸‰é€‰ä¸€ï¼Œç‚¹å‡» "Pick"ã€‚
- ç¤ºä¾‹æ•°æ®:
  1. **Lightning (é—ªç”µé“¾):** Attacks have a 10% chance to unleash 2 projectiles dealing 100% of your damage. (ç‰¹æ•ˆæµ)
  2. **Healing Strike (æ²»æ„ˆæ‰“å‡»):** Attacks have a 5% chance to Heal 5% of your total HP. (ç»­èˆªæµ)
  3. **Heavy Blow (é‡å‡»):** Gain 1 charge per Attack. At 10 charges, deal 200% of your total damage. (æ”»é€Ÿæµ/å……èƒ½æµ)

------

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°å€¼åˆ—è¡¨ä¸è¯´æ˜ (Data Structures)

### 2.1 ç©å®¶å±æ€§ç»“æ„ (PlayerStats)

JSON

```
{   "damage": 56,          // åŸºç¡€å€¼ + å±€å¤–å‡çº§ + è£…å¤‡åŠ æˆ   "health": 686,   "attackSpeed": 36,     // å¯èƒ½æ˜¯å…·ä½“æ•°å€¼ï¼Œè®¡ç®—å…¬å¼ï¼šBase / (1 + Speed/100)   "armor": 28,           // å‡ä¼¤å…¬å¼ï¼šDamage * (1 - Armor / (Armor + K))   "crit": 56,            // ç™¾åˆ†æ¯”ï¼Œ56%   "toughness": 25,       // æŠµæŠ—æš´å‡»ç‡   "dodge": 16,           // é—ªé¿ç‡ %   "accuracy": 19,        // å‘½ä¸­ä¿®æ­£   "lifesteal": 0,        // å¸è¡€ %   "bleed": 0             // æµè¡€ä¼¤å®³å€¼æˆ–å±‚æ•° }
```

### 2.2 æŠ€èƒ½æ•°æ®è¡¨ (SkillTable)

| **ID** | **Name**       | **Type** | **Trigger** | **Value1**  | **Value2** | **Desc**                         |
| ------ | -------------- | -------- | ----------- | ----------- | ---------- | -------------------------------- |
| 101    | Lightning      | Passive  | OnAttack    | 10 (prob)   | 100 (dmg%) | 10%å‡ ç‡é‡Šæ”¾2ä¸ªæŠ•å°„ç‰©é€ æˆ100%ä¼¤å®³ |
| 102    | Healing Strike | Passive  | OnAttack    | 5 (prob)    | 5 (hp%)    | 5%å‡ ç‡æ¢å¤5%æœ€å¤§ç”Ÿå‘½å€¼           |
| 103    | Heavy Blow     | Passive  | OnCharge    | 10 (stacks) | 200 (dmg%) | æ¯æ”»å‡»1æ¬¡å……èƒ½ï¼Œ10å±‚é€ æˆ200%ä¼¤å®³  |

### 2.3 åœ°å›¾èŠ‚ç‚¹é…ç½® (MapNodes)

JSON

```
[   { "id": 1, "type": "START", "next": [2] },   { "id": 2, "type": "ENEMY", "next": [3, 4] }, // åˆ†å²”ç‚¹   { "id": 3, "type": "FOUNTAIN", "next": [5] }, // å·¦è·¯å»æ³‰æ°´   { "id": 4, "type": "CHEST", "next": [5] },    // å³è·¯å»æ‹¿è£…å¤‡   { "id": 5, "type": "HEART", "next": [6] }     // æ±‡åˆå›è¡€ ]
```

------

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¼€å‘æŠ€æœ¯æ–‡æ¡£ (Technical Specs)

### 3.1 æ ¸å¿ƒç±»è®¾è®¡ (Class Design)

### **1. GameManager (å•ä¾‹)**

- `playerData`: å­˜å‚¨é‡‘å¸ã€å½“å‰å…³å¡è¿›åº¦ã€å·²è§£é”ç« èŠ‚ã€‚
- `globalStats`: å­˜å‚¨å±€å¤–å‡çº§åçš„æ°¸ä¹…å±æ€§ï¼ˆBook tabçš„æ•°æ®ï¼‰ã€‚
- `gameState`: æšä¸¾ `MENU`, `MAP`, `BATTLE`, `EVENT`, `SETTLEMENT`.

### **2. MapManager (åœ°å›¾ç”Ÿæˆå™¨)**

- **åŠŸèƒ½:** è´Ÿè´£æ ¹æ®é…ç½®ç”Ÿæˆå±‚çº§èŠ‚ç‚¹å›¾ã€‚
- **æ•°æ®ç»“æ„:** åŒå‘é“¾è¡¨æˆ–æœ‰å‘æ— ç¯å›¾ (DAG) å­˜å‚¨èŠ‚ç‚¹è¿æ¥å…³ç³»ã€‚
- **é€»è¾‘:** ç©å®¶å¤„äº Node A æ—¶ï¼Œç‚¹å‡» Node Bï¼Œå¦‚æœ `A.next` åŒ…å« `B`ï¼Œåˆ™è§¦å‘ç§»åŠ¨åŠ¨ç”»ï¼Œåˆ°ä½åæ ¹æ® `B.type` è§¦å‘äº‹ä»¶ã€‚

### **3. StatsManager (å±æ€§è®¡ç®—å™¨)**

- è¿™æ˜¯æ•´ä¸ªæ¸¸æˆçš„æ•°å€¼å¿ƒè„ã€‚

- **å…¬å¼:** `FinalStat = (BaseStat + BookUpgrade) * (1 + EquipPercent) + EquipFlat`

- **UpgradeUpgrade (å±€å¤–å‡çº§é€»è¾‘):**TypeScript

  `function generateUpgradeOptions() {       // ä»10ä¸ªå±æ€§ä¸­éšæœºå–2ä¸ª       let type1 = Random.pick(StatTypes);       let type2 = Random.pick(StatTypes);       // æ ¹æ®å½“å‰ç­‰çº§è®¡ç®—å¢å¹…æ•°å€¼       let val1 = calculateGrowth(type1);        let val2 = calculateGrowth(type2);       return [ {type: type1, val: val1}, {type: type2, val: val2} ];   }`

### **4. BattleSystem (æˆ˜æ–—ç³»ç»Ÿ)**

- ç”±äºæ˜¯ç¬¬ä¸€äººç§°ï¼Œæ— éœ€å¤æ‚çš„å¯»è·¯ã€‚

- **EnemyLogic:** æ¯éš” `Interval` ç§’æ”»å‡»ä¸€æ¬¡ç©å®¶ã€‚

- **PlayerLogic:** è‡ªåŠ¨æ”»å‡»ã€‚

- EventLoop:

   \* 

  ```
  OnAttack
  ```

  : è§¦å‘å¸è¡€ã€æš´å‡»ã€é‡å‡»è®¡æ•°ã€é—ªç”µé“¾æ£€æµ‹ã€‚

  - `OnHit`: è§¦å‘é—ªé¿ã€æŠ¤ç”²å‡ä¼¤ã€éŸ§æ€§åˆ¤å®šã€‚

### **5. InventorySystem (8æ§½ä½ç®¡ç†)**

- UIå¸ƒå±€ï¼šä½¿ç”¨ `Grid Layout`ï¼Œ2è¡Œ4åˆ—ã€‚
- æ•°æ®ï¼š`slots: Equipment[8]`ã€‚
- é€»è¾‘ï¼šè·å¾—æ–°è£…å¤‡æ—¶ï¼Œåˆ¤æ–­ç±»å‹ã€‚
  - å¦‚æœæ˜¯ `Weapon`ï¼Œå¯¹æ¯” `slots[0]`ã€‚
  - å¦‚æœæ˜¯ `Ring`ï¼Œå¯¹æ¯” `slots[5]` (å‡è®¾æˆ’æŒ‡åœ¨ç¬¬6æ ¼)ã€‚
  - **å¯¹æ¯”UI:** å¿…é¡»æ¸…æ™°å±•ç¤º 10é¡¹å±æ€§çš„å˜åŒ–ï¼ˆç»¿è‰²ä¸Šå‡ï¼Œçº¢è‰²ä¸‹é™ï¼‰ã€‚

### 3.2 å¼€å‘ä¼˜å…ˆçº§ (Sprint Plan)

1. é˜¶æ®µä¸€ï¼šæ•°å€¼ä¸å±æ€§æ¡†æ¶ (The Stats)
   - å®ç° `StatsManager`ï¼Œå®šä¹‰å¥½10ç§å±æ€§ã€‚
   - åˆ¶ä½œä¸»ç•Œé¢çš„ "Book" é¡µç­¾ï¼Œå®ç°â€œèŠ±é’± -> éšæœºäºŒé€‰ä¸€ -> å±æ€§å¢åŠ â€çš„é€»è¾‘ã€‚è¿™æ˜¯æœ€ç®€å•çš„é—­ç¯ã€‚
2. é˜¶æ®µäºŒï¼šåœ°å›¾è¡Œèµ° (The Map)
   - å®ç°å·è½´åœ°å›¾ç”Ÿæˆã€‚
   - å®ç°èŠ‚ç‚¹ç‚¹å‡»ç§»åŠ¨ã€‚
   - å®ç° æ³‰æ°´(é€‰æŠ€èƒ½UI) å’Œ çº¢å¿ƒ(å›è¡€) çš„é€»è¾‘ã€‚
3. é˜¶æ®µä¸‰ï¼šæˆ˜æ–—ä¸è£…å¤‡ (The Battle)
   - å®ç°8ä¸ªæ§½ä½çš„UIã€‚
   - å®ç°æˆ˜æ–—å¾ªç¯ã€‚
   - å®ç°æ ¸å¿ƒçš„â€œå‡»è´¥æ€ªç‰© -> æ‰è½å¡ç‰‡ -> å·¦å³æ»‘è£…å¤‡â€äº¤äº’ã€‚

# ã€ŠPath of Kingsã€‹å¤åˆ»ç‰ˆ - ç»¼åˆé¡¹ç›®å¼€å‘ç™½çš®ä¹¦

ç‰ˆæœ¬ï¼š v1.0

æ—¥æœŸï¼š 2023-12-11

è§’è‰²ï¼š å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ & ä¸»ç­–åˆ’

ç›®æ ‡å¹³å°ï¼š H5 (ç§»åŠ¨ç«¯æµè§ˆå™¨ / å¾®ä¿¡å°æ¸¸æˆ)

å¼€å‘å¼•æ“ï¼š Cocos Creator 3.8.x (TypeScript)

------

## 1. äº§å“æ¦‚è¿° (Executive Summary)

### 1.1 æ ¸å¿ƒæ¦‚å¿µ (High Concept)

ä¸€æ¬¾ç»“åˆäº† **Roguelike é—¯å…³** ä¸ **Tinderå¼æ»‘åŠ¨äº¤äº’** çš„ç¬¬ä¸€äººç§°åƒç´ é£ RPGã€‚ç©å®¶é€šè¿‡æç®€çš„â€œå·¦æ»‘å‡ºå”®ã€å³æ»‘ç©¿æˆ´â€æ“ä½œæ¥æ„å»ºè£…å¤‡ä½“ç³»ï¼Œåœ¨ä¸æ–­ç”Ÿæˆçš„éšæœºåœ°å›¾ä¸­æŒ‘æˆ˜æ›´é«˜å±‚çº§çš„æ•Œäººã€‚

### 1.2 æ ¸å¿ƒä½“éªŒ (Core Pillars)

1. **æç®€å†³ç­– (Swipe Decision):** å°†å¤æ‚çš„è£…å¤‡æ¯”å¯¹ç®€åŒ–ä¸ºä¸€ç§’å†…çš„ç›´è§‰æ»‘åŠ¨ã€‚
2. **æ•°å€¼çˆ½æ„Ÿ (Progression):** æ¸…æ™°çš„å±æ€§æˆé•¿ï¼ˆ10ç»´å±æ€§ï¼‰å’Œè£…å¤‡è¿­ä»£ã€‚
3. **éšæœºæ¢ç´¢ (Roguelike):** éšæœºåœ°å›¾èŠ‚ç‚¹ã€éšæœºæ‰è½ã€ä¸‰é€‰ä¸€æŠ€èƒ½æ„å»ºã€‚

------

## 2. æ¸¸æˆç³»ç»Ÿä¸ç•Œé¢è®¾è®¡ (Game Design & UI)

### 2.1 ç•Œé¢æ¶æ„å›¾ (UI Flow)

```
ä¸»ç•Œé¢` -> `å†’é™©å‡†å¤‡(ç« èŠ‚é€‰æ‹©)` -> `åœ°å›¾ç•Œé¢` -> `æˆ˜æ–—/äº‹ä»¶èŠ‚ç‚¹` -> `ç»“ç®—
```

### 2.2 è¯¦ç»†ç•Œé¢åŠŸèƒ½

### A. ä¸»ç•Œé¢ (Main Menu) - åº•éƒ¨ä¸‰å¤§å…¥å£

å¯¹åº”åŠŸèƒ½ï¼šå±€å¤–æˆé•¿ä¸èµ„æºç®¡ç†ã€‚

1. **å·¦ä¾§ - èƒŒåŒ… (Inventory):** æŸ¥çœ‹å½“å‰èº«ä¸Šçš„ 8 ä»¶è£…å¤‡ã€‚

2. ä¸­é—´ - å†’é™© (Adventure):

   - **ç« èŠ‚é€‰æ‹©:** å·¦å³åˆ‡æ¢åœ°å›¾ï¼ˆå¦‚ Chapter 2: Frostwood Riseï¼‰ã€‚
   - **æ‰è½é¢„è§ˆ:** æ˜¾ç¤ºæœ¬ç« æ‰ç‡ï¼ˆCommon 80%, Uncommon 19%, Rare 1%ï¼‰ã€‚
   - **å…¥å£æŒ‰é’®:** "ENTER LEVEL X"ã€‚

3. å³ä¾§ - é­”æ³•ä¹¦ (Stats Upgrade):

   [æ ¸å¿ƒç»æµå¾ªç¯]

   - **é¢æ¿:** æ˜¾ç¤º 10 é¡¹æ€»å±æ€§ã€‚
   - **å‡çº§æŒ‰é’®:** æ˜¾ç¤ºèŠ±è´¹ï¼ˆå¦‚ 250 Goldï¼‰ã€‚
   - **å‡çº§äº¤äº’:** ç‚¹å‡»åæ‰£è´¹ -> éšæœºç”Ÿæˆ **2ä¸ª** å±æ€§æå‡é€‰é¡¹ -> å±å¹•æ˜¾ç¤ºå…¶ä¸­ä¸€å¼ å¡ç‰‡ -> **å³æ»‘ä¿ç•™(Keep)** æˆ– **å·¦æ»‘æ”¾å¼ƒå¹¶æ¢å–å¤‡é€‰é¡¹(Swap/Discard)**ã€‚

### B. åœ°å›¾ç³»ç»Ÿ (Map System)

å¯¹åº”åŠŸèƒ½ï¼šRoguelike è·¯çº¿è§„åˆ’ã€‚

- **è¡¨ç°:** å‚ç›´å·è½´å¼åœ°å›¾ï¼Œè‡ªä¸‹è€Œä¸Šæ¨è¿›ã€‚
- èŠ‚ç‚¹ç±»å‹:
  - ğŸš© **Start:** èµ·ç‚¹ã€‚
  - ğŸ’€ **Enemy:** æ™®é€šæˆ˜æ–—ï¼ˆæ‰è½æ™®é€šè£…å¤‡ï¼‰ã€‚
  - ğŸ“¦ **Chest:** å®ç®±æˆ˜æ–—ï¼ˆå¿…æ‰è£…å¤‡ï¼Œå‡ ç‡é«˜å“è´¨ï¼‰ã€‚
  - â›² **Fountain:** æŠ€èƒ½å‡çº§ï¼ˆè§¦å‘ä¸‰é€‰ä¸€ï¼‰ã€‚
  - â¤ï¸ **Heart:** æ¢å¤ç”Ÿå‘½å€¼ï¼ˆå›è¡€ 30%-50%ï¼‰ã€‚
  - ğŸ‘¹ **Boss:** ç« èŠ‚ç»ˆç‚¹ã€‚

### C. æˆ˜æ–—ä¸è£…å¤‡äº¤äº’ (Battle & Loot)

å¯¹åº”åŠŸèƒ½ï¼šæ ¸å¿ƒç©æ³•å¾ªç¯ã€‚

- **è§†è§’:** ç¬¬ä¸€äººç§°ï¼Œæ˜¾ç¤ºæ‰‹éƒ¨/æ­¦å™¨ï¼Œæ•Œäººä»è¿œå¤„èµ°è¿‘ã€‚

- **æˆ˜æ–—é€»è¾‘:** è‡ªåŠ¨æ”»å‡»ï¼Œè‡ªåŠ¨å—å‡»ã€‚

- æ‰è½äº¤äº’ (The Swipe):

   å‡»è´¥æ•Œäººåå¼¹å‡ºè£…å¤‡å¡ç‰‡ã€‚

  - **UIä¿¡æ¯:** æ˜¾ç¤ºæ–°è£…å¤‡å›¾æ ‡ã€å“è´¨é¢œè‰²ã€æ ¸å¿ƒå±æ€§ã€‚
  - **å¯¹æ¯”ä¿¡æ¯:** å¿…é¡»æ˜¾ç¤ºä¸å½“å‰æ§½ä½æ—§è£…å¤‡çš„å·®å€¼ï¼ˆä¾‹ï¼š`æ”»å‡» +10 (ğŸŸ¢)`, `é˜²å¾¡ -5 (ğŸ”´)`ï¼‰ã€‚
  - æ“ä½œ:
    - **ğŸ‘‰ å³æ»‘ (Right):** **ç©¿æˆ´ (Equip)**ã€‚æ–°è£…å¤‡æ›¿æ¢æ—§è£…å¤‡ï¼Œæ—§è£…å¤‡é”€æ¯ã€‚
    - **ğŸ‘ˆ å·¦æ»‘ (Left):** **å‡ºå”® (Sell)**ã€‚è·å¾—å°‘é‡é‡‘å¸ï¼Œä¿ç•™æ—§è£…å¤‡ã€‚

### D. æŠ€èƒ½é€‰æ‹© (Ability Draft)

å¯¹åº”åŠŸèƒ½ï¼šBuild æ„å»ºã€‚

- **è§¦å‘:** æ³‰æ°´èŠ‚ç‚¹æˆ–å‡çº§ã€‚
- **äº¤äº’:** å¼¹å‡º 3 å¼ æŠ€èƒ½å¡ï¼Œç‚¹å‡» "Pick" é€‰æ‹©å…¶ä¸€ã€‚
- **å¹¿å‘Šç‚¹:** åº•éƒ¨ "Take All" æŒ‰é’®ï¼ˆçœ‹å¹¿å‘Šè·å¾—æ‰€æœ‰ 3 ä¸ªæŠ€èƒ½ï¼‰ã€‚

------

## 3. æ•°å€¼ä½“ç³» (Numerical Framework)

### 3.1 åŸºç¡€å±æ€§ (The 10 Stats)

è¿™æ˜¯æ‰€æœ‰è®¡ç®—çš„åº•å±‚ä¾æ®ã€‚

| **ID** | **è‹±æ–‡å**    | **ä¸­æ–‡å** | **ä½œç”¨æœºåˆ¶**               |
| ------ | ------------- | ---------- | -------------------------- |
| 0      | **Damage**    | æ”»å‡»åŠ›     | åŸºç¡€ä¼¤å®³è¾“å‡º               |
| 1      | **Health**    | ç”Ÿå‘½å€¼     | ç”Ÿå­˜è¡€é‡ä¸Šé™               |
| 2      | **Atk Speed** | æ”»é€Ÿ       | æ”»å‡»é¢‘ç‡ (æ¬¡/ç§’)           |
| 3      | **Armor**     | æŠ¤ç”²       | ç™¾åˆ†æ¯”ç‰©ç†å‡ä¼¤             |
| 4      | **Crit**      | æš´å‡»ç‡     | é€ æˆ 200% ä¼¤å®³çš„æ¦‚ç‡       |
| 5      | **Toughness** | éŸ§æ€§       | é™ä½è¢«æš´å‡»çš„æ¦‚ç‡           |
| 6      | **Dodge**     | é—ªé¿       | å®Œå…¨è§„é¿ä¼¤å®³çš„æ¦‚ç‡         |
| 7      | **Accuracy**  | å‘½ä¸­       | é™ä½æ•Œäººé—ªé¿çš„æ¦‚ç‡         |
| 8      | **Lifesteal** | å¸è¡€       | é€ æˆä¼¤å®³æ—¶å›å¤ç”Ÿå‘½çš„ç™¾åˆ†æ¯” |
| 9      | **Bleed**     | æµè¡€       | æ”»å‡»é™„åŠ æŒç»­ä¼¤å®³ (DoT)     |

### 3.2 è£…å¤‡æ§½ä½ (8 Slots)

1. **Weapon:** ä¸»æ‰‹æ­¦å™¨ (å‰‘/æ–§/é”¤)
2. **Armor:** èº«ä½“æŠ¤ç”²
3. **Helmet:** å¤´éƒ¨é˜²å…·
4. **Boots:** é‹å­
5. **Accessory 1:** é¡¹é“¾/å‹‹ç« 
6. **Accessory 2:** æˆ’æŒ‡
7. **Offhand:** å‰¯æ‰‹/å® ç‰© (å¦‚ä¹¦æœ¬è€é¼ )
8. **Special:** æŠ¤è…¿/ç‰¹æ®Šè£…å¤‡

### 3.3 æ ¸å¿ƒå…¬å¼ (ç®€åŒ–ç‰ˆ)

- **ä¼¤å®³å…¬å¼:** `FinalDmg = (Atk - TargetDef) * Random(0.9, 1.1)`

- **æš´å‡»åˆ¤å®š:** `If (Rand() < (Crit - TargetToughness)) -> FinalDmg * 2`

- **å‘½ä¸­åˆ¤å®š:** `HitChance = 1 - (TargetDodge - AttackerAcc)`

- å±æ€§æˆé•¿:

  ```
  StatValue = Base * (1.1 ^ Level) * QualityMultiplier
  ```

  - *å“è´¨ç³»æ•°:* ç™½(1.0), ç»¿(1.2), è“(1.5), ç´«(2.0), æ©™(3.0)

------

## 4. æŠ€æœ¯æ¶æ„å¼€å‘æ–‡æ¡£ (Technical Architecture)

### 4.1 ç›®å½•ç»“æ„ (Directory)

Plaintext

```
assets/   â”œâ”€â”€ Scripts/   â”‚   â”œâ”€â”€ Core/           # GameManager, DataManager, EventManager   â”‚   â”œâ”€â”€ Data/           # GameType, MapConfig, SkillData, EquipmentData   â”‚   â”œâ”€â”€ Entity/         # Player, Enemy, BattleEntity   â”‚   â”œâ”€â”€ UI/             # SwipeCard, MapNodeView, StatsPanel, HudView   â”‚   â””â”€â”€ Utils/          # StorageManager, MathUtils   â”œâ”€â”€ Prefabs/            # Card, MapNode, Monster, Effect   â””â”€â”€ Scenes/             # MainScene, AdventureScene
```

### 4.2 æ ¸å¿ƒç±»è®¾è®¡ (Class Design)

### 1. `DataManager` (Singleton)

- **èŒè´£:** ç®¡ç†å…¨å±€æ•°æ®ï¼ˆé‡‘å¸ã€10ç»´å±æ€§ã€å½“å‰è£…å¤‡ï¼‰ã€‚
- æ•°æ®:
  - `playerStats: number[]` (é•¿åº¦10çš„æ•°ç»„)
  - `inventory: Map<SlotType, EquipmentData>` (8ä¸ªæ§½ä½)
  - `gold: number`

### 2. `SwipeCard` (Component)

- **èŒè´£:** å¤„ç†å¡ç‰‡çš„ç‰©ç†æ‹–æ‹½ã€å›å¼¹ã€é£å‡ºé€»è¾‘ã€‚
- API:
  - `onSwipeRight: () => void`
  - `onSwipeLeft: () => void`
- **é€»è¾‘:** ç›‘å¬ TouchMoveï¼Œæ ¹æ® X è½´ä½ç§»è®¾ç½® `rotation` å’Œ `overlay` (æç¤ºå±‚) é€æ˜åº¦ã€‚

### 3. `MapManager` & `MapGenerator`

- **èŒè´£:** ç”ŸæˆéšæœºèŠ‚ç‚¹å›¾ï¼Œå¤„ç†èŠ‚ç‚¹è¿æ¥ã€‚
- ç®—æ³•:
  - ç”Ÿæˆ N å±‚æ•°æ®ã€‚
  - æ¯å±‚éšæœº 1-3 ä¸ªèŠ‚ç‚¹ã€‚
  - ç¡®ä¿å±‚ä¸å±‚ä¹‹é—´è‡³å°‘æœ‰ä¸€æ¡è¿çº¿ã€‚
- **æ¸²æŸ“:** ä½¿ç”¨ `cc.Graphics` ç»˜åˆ¶è¿æ¥çº¿ï¼Œå®ä¾‹åŒ– Node Prefabã€‚

### 4. `InventoryManager`

- **èŒè´£:** è£…å¤‡çš„ç”Ÿæˆã€å¯¹æ¯”ã€ç©¿æˆ´ã€‚
- æ ¸å¿ƒæ–¹æ³•:
  - `generateGear(level)`: æ ¹æ®æƒé‡ç”Ÿæˆè£…å¤‡ã€‚
  - `compare(newGear)`: è¿”å›å±æ€§å·®å¼‚å¯¹è±¡ `{ diffDamage: +5, diffArmor: -2 }`ã€‚

### 5. `SkillManager`

- **èŒè´£:** æˆ˜æ–—å†…è¢«åŠ¨æŠ€èƒ½è§¦å‘ã€‚
- **é€»è¾‘:** ç›‘å¬ `BattleEvent` (ON_ATTACK, ON_HIT)ï¼Œæ ¹æ®æ¦‚ç‡æ‰§è¡Œæ•ˆæœã€‚

### 4.3 æ•°æ®æŒä¹…åŒ– (Storage)

ä½¿ç”¨ `localStorage` å­˜å‚¨ JSONï¼š

JSON

```
{   "gold": 420,   "stats": [56, 686, 36, ...],   "inventory": [ { "slot": 0, "id": 101, "stats": [...] }, ... ],   "unlockedChapters": 2 }
```

------

## 5. å¼€å‘é‡Œç¨‹ç¢‘ (Roadmap)

### Phase 1: æ ¸å¿ƒäº¤äº’éªŒè¯ (MVP)

- [ ]  æ­å»º Cocos é¡¹ç›®åŸºç¡€ã€‚
- [ ]  å®ç° `SwipeCard` ç»„ä»¶ï¼ˆæ‰‹æ„Ÿè°ƒä¼˜ï¼‰ã€‚
- [ ]  å®ç°ä¸»ç•Œé¢ `Stats Upgrade` åŠŸèƒ½ï¼ˆé‡‘å¸ -> éšæœº2é€‰1 -> æ»‘åŠ¨å‡çº§ï¼‰ã€‚
- **äº§å‡º:** å¯ç©çš„å±æ€§å‡çº§ Demoã€‚

### Phase 2: åœ°å›¾ä¸æµç¨‹

- [ ]  å®ç° `MapGenerator` ç®—æ³•ã€‚
- [ ]  åˆ¶ä½œå·è½´å¼åœ°å›¾ UIï¼Œæ”¯æŒç‚¹å‡»èŠ‚ç‚¹ç§»åŠ¨å°äººã€‚
- [ ]  å®ç°èŠ‚ç‚¹äº‹ä»¶æ¡†æ¶ï¼ˆç‚¹å‡» -> è§¦å‘ logï¼‰ã€‚
- **äº§å‡º:** å®Œæ•´çš„é€‰å…³æµç¨‹ã€‚

### Phase 3: æˆ˜æ–—ä¸è£…å¤‡å¾ªç¯

- [ ]  å®ç°ä¼ª 3D æˆ˜æ–—åœºæ™¯ï¼ˆæ•Œäººèµ°è¿‘ï¼‰ã€‚
- [ ]  å®ç° `EquipmentGenerator` å’Œ `InventoryManager`ã€‚
- [ ]  åˆ¶ä½œè£…å¤‡å¯¹æ¯”å¡ç‰‡ UIï¼ˆæ˜¾ç¤ºå±æ€§å·®å€¼ï¼‰ã€‚
- [ ]  ä¸²è”ï¼šæˆ˜æ–— -> æ‰è½ -> æ»‘åŠ¨å†³ç­– -> å±æ€§å˜æ›´ã€‚
- **äº§å‡º:** æ¸¸æˆæ ¸å¿ƒé—­ç¯è·‘é€šã€‚

### Phase 4: æŠ€èƒ½ä¸å®Œå–„

- [ ]  åˆ¶ä½œæŠ€èƒ½æ•°æ®è¡¨ä¸å›¾æ ‡ã€‚
- [ ]  å®ç°ä¸‰é€‰ä¸€ UI åŠ `Take All` å¹¿å‘Šé€»è¾‘ã€‚
- [ ]  æ¥å…¥ `StorageManager` å­˜æ¡£ç³»ç»Ÿã€‚
- [ ]  å¢åŠ éŸ³æ•ˆä¸éœ‡åŠ¨åé¦ˆã€‚

------

## 6. é™„å½•ï¼šèµ„æºéœ€æ±‚æ¸…å•

1. **UI å›¾æ ‡:** 10ä¸ªå±æ€§å›¾æ ‡ï¼Œ8ä¸ªè£…å¤‡éƒ¨ä½å ä½ç¬¦ï¼Œé‡‘å¸ï¼Œè®¾ç½®ã€‚
2. **è£…å¤‡ç´ æ:** åƒç´ é£å‰‘ã€ç›¾ã€ç”²ã€é‹ç­‰ï¼ˆæŒ‰ç¨€æœ‰åº¦æ¢è‰²ï¼‰ã€‚
3. **åœºæ™¯ç´ æ:** 3-4 å¼ ä¸åŒé£æ ¼çš„èƒŒæ™¯å›¾ï¼ˆæ£®æ—ã€æ²™æ¼ ã€åœ°ç‰¢ï¼‰ã€‚
4. **æ•Œäººç´ æ:** 5-10 ç§æ€ªç‰© Spriteï¼ˆå²è±å§†ã€éª·é«…ã€è™è ã€Bossï¼‰ã€‚
5. **éŸ³æ•ˆ:** æŒ¥åˆ€ã€å‘½ä¸­ã€é‡‘å¸è·å¾—ã€å¡ç‰‡é£å‡ºã€å‡çº§æˆåŠŸã€‚

### ğŸ“… å¼€å‘é˜¶æ®µä¸€ï¼šå±æ€§å‡çº§ä¸æ ¸å¿ƒäº¤äº’

### 1. æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰ (`GameType.ts`)

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŠŠé‚£10ä¸ªå±æ€§å›ºå®šä¸‹æ¥ï¼Œå¹¶å®šä¹‰å¥½å®ƒä»¬çš„IDå’Œæ˜¾ç¤ºåç§°ï¼Œæ–¹ä¾¿åç»­è°ƒç”¨ã€‚

TypeScript

`// assets/Scripts/Data/GameType.ts

export enum StatType { Damage = 0, Health = 1, AttackSpeed = 2, Armor = 3, Crit = 4, Toughness = 5, Dodge = 6, Accuracy = 7, Lifesteal = 8, Bleed = 9 }

export const StatConfig = { [StatType.Damage]:       { name: "Damage",       icon: "icon_sword",    base: 10,  growth: 2 }, [StatType.Health]:       { name: "Health",       icon: "icon_heart",    base: 100, growth: 20 }, [StatType.AttackSpeed]:  { name: "Attack Speed", icon: "icon_wind",     base: 10,  growth: 1 }, [StatType.Armor]:        { name: "Armor",        icon: "icon_shield",   base: 5,   growth: 1 }, [StatType.Crit]:         { name: "Crit",         icon: "icon_star",     base: 5,   growth: 1 }, [StatType.Toughness]:    { name: "Toughness",    icon: "icon_arm",      base: 0,   growth: 1 }, [StatType.Dodge]:        { name: "Dodge",        icon: "icon_boot",     base: 0,   growth: 1 }, [StatType.Accuracy]:     { name: "Accuracy",     icon: "icon_target",   base: 90,  growth: 1 }, [StatType.Lifesteal]:    { name: "Lifesteal",    icon: "icon_vampire",  base: 0,   growth: 0.5 }, [StatType.Bleed]:        { name: "Bleed",        icon: "icon_blood",    base: 0,   growth: 2 }, };

export interface UpgradeOption { type: StatType; value: number; // å¢åŠ çš„å…·ä½“æ•°å€¼ isRecommended?: boolean; // ç”¨äºUIæ˜¾ç¤ºâ€œæ¨èâ€æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰ }`

------

### 2. ç”¨æˆ·æ•°æ®ç®¡ç† (`DataManager.ts`)

è¿™æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œè´Ÿè´£å­˜é’±ã€å­˜å±æ€§ã€‚

TypeScript

`// assets/Scripts/Core/DataManager.ts import { _decorator, Component } from 'cc'; import { StatType, StatConfig } from '../Data/GameType'; const { ccclass, property } = _decorator;

@ccclass('DataManager') export class DataManager { private static _instance: DataManager;

```
public static get instance(): DataManager {
    if (!this._instance) this._instance = new DataManager();
    return this._instance;
}

// æ ¸å¿ƒæ•°æ®
public gold: number = 420; // åˆå§‹é‡‘å¸ï¼Œå‚è€ƒæˆªå›¾
public playerStats: number[] = []; // å­˜å‚¨10ä¸ªå±æ€§çš„å½“å‰å€¼
public upgradeCost: number = 250; // åˆå§‹å‡çº§ä»·æ ¼

constructor() {
    this.initStats();
}

private initStats() {
    // åˆå§‹åŒ–åŸºç¡€å±æ€§
    for (let i = 0; i < 10; i++) {
        this.playerStats[i] = StatConfig[i].base;
    }
}

// è·å–å½“å‰å±æ€§å€¼
public getStat(type: StatType): number {
    return this.playerStats[type];
}

// å¢åŠ å±æ€§
public addStat(type: StatType, value: number) {
    this.playerStats[type] += value;
    // å‡çº§åä»·æ ¼ä¸Šæ¶¨ 10%
    this.upgradeCost = Math.floor(this.upgradeCost * 1.1); 
}

// æ‰£é’±
public consumeGold(amount: number): boolean {
    if (this.gold >= amount) {
        this.gold -= amount;
        return true;
    }
    return false;
}
```

}`

------

### 3. æ ¸å¿ƒäº¤äº’ï¼šä¸‡èƒ½çš„æ»‘åŠ¨å¡ç‰‡ (`SwipeCard.ts`)

è¿™æ˜¯**æœ€é‡è¦**çš„ä»£ç ã€‚å®ƒå°†è¢«ç”¨äºå±æ€§å‡çº§ã€è£…å¤‡é€‰æ‹©ç­‰æ‰€æœ‰ç¯èŠ‚ã€‚ å®ç°äº†ï¼šæ‹–æ‹½è·Ÿéšã€æ—‹è½¬æ‰‹æ„Ÿã€é˜ˆå€¼åˆ¤æ–­ã€å›è°ƒäº‹ä»¶ã€‚

TypeScript

`// assets/Scripts/UI/SwipeCard.ts import { _decorator, Component, Node, EventTouch, Vec3, UITransform, Label, Sprite } from 'cc'; const { ccclass, property } = _decorator;

@ccclass('SwipeCard') export class SwipeCard extends Component {

```
@property(Node) overlayRight: Node = null!; // å³æ»‘æç¤º(ç»¿è‰²/Upgrade)
@property(Node) overlayLeft: Node = null!;  // å·¦æ»‘æç¤º(çº¢è‰²/Sellæˆ–Discard)

// é…ç½®å‚æ•°
private swipeThreshold: number = 150; // æ»‘åŠ¨è§¦å‘è·ç¦»
private rotationFactor: number = 0.1; // æ—‹è½¬ç³»æ•°
private returnSpeed: number = 10;     // å›å¼¹é€Ÿåº¦

private _startPos: Vec3 = new Vec3();
private _isDragging: boolean = false;

// å›è°ƒå‡½æ•°
public onSwipeRight: () => void = null;
public onSwipeLeft: () => void = null;

onLoad() {
    this._startPos = this.node.position.clone();
    this.node.on(Node.EventType.TOUCH_START, this.onTouchStart, this);
    this.node.on(Node.EventType.TOUCH_MOVE, this.onTouchMove, this);
    this.node.on(Node.EventType.TOUCH_END, this.onTouchEnd, this);
    this.node.on(Node.EventType.TOUCH_CANCEL, this.onTouchEnd, this);
}

onTouchStart(event: EventTouch) {
    this._isDragging = true;
}

onTouchMove(event: EventTouch) {
    if (!this._isDragging) return;

    const delta = event.getUIDelta();
    const currentPos = this.node.position;
    
    // 1. è·Ÿéšæ‰‹æŒ‡ç§»åŠ¨ (Xè½´ä¸ºä¸»ï¼ŒYè½´è½»å¾®è·Ÿéš)
    this.node.setPosition(currentPos.x + delta.x, currentPos.y + delta.y * 0.5);

    // 2. æ ¸å¿ƒæ‰‹æ„Ÿï¼šæ ¹æ®Xè½´ä½ç§»è¿›è¡Œæ—‹è½¬
    const angle = this.node.position.x * -this.rotationFactor;
    this.node.setRotationFromEuler(0, 0, angle);

    // 3. UIåé¦ˆï¼šæ§åˆ¶ Overlay é€æ˜åº¦
    this.updateOverlays();
}

onTouchEnd(event: EventTouch) {
    this._isDragging = false;
    
    // åˆ¤æ–­æ˜¯å¦è§¦å‘é˜ˆå€¼
    if (this.node.position.x > this.swipeThreshold) {
        this.handleChoice(true); // Right
    } else if (this.node.position.x < -this.swipeThreshold) {
        this.handleChoice(false); // Left
    } else {
        this.resetCard(); // å›å¼¹
    }
}

updateOverlays() {
    const x = this.node.position.x;
    // å³æ»‘æ˜¾ç¤ºç»¿è‰²æç¤ºï¼Œå·¦æ»‘æ˜¾ç¤ºçº¢è‰²æç¤º
    if (this.overlayRight) this.overlayRight.active = x > 0;
    if (this.overlayLeft) this.overlayLeft.active = x < 0;
    
    const opacity = Math.min(Math.abs(x) / (this.swipeThreshold * 0.8) * 255, 255);
    
    if (x > 0 && this.overlayRight) {
         this.overlayRight.getComponent(Sprite).color = new  ethers.Color(255, 255, 255, opacity); // ä¼ªä»£ç ï¼Œéœ€é…åˆSpriteç»„ä»¶è®¾ç½®é€æ˜åº¦
    }
    // ... left åŒç†
}

handleChoice(isRight: boolean) {
    // é£å‡ºåŠ¨ç”»
    const targetX = isRight ? 1000 : -1000;
    // ä½¿ç”¨ Tween é£å‡º
    // tween(this.node).to(0.2, { position: new Vec3(targetX, 0, 0) }).call(() => {
        if (isRight && this.onSwipeRight) this.onSwipeRight();
        if (!isRight && this.onSwipeLeft) this.onSwipeLeft();
        this.node.destroy(); // æˆ–æ”¾å…¥å¯¹è±¡æ± å›æ”¶
    // }).start();
}

resetCard() {
    // å›å¼¹åŠ¨ç”»
    // tween(this.node).to(0.3, { position: this._startPos, rotation: Quat.IDENTITY }).start();
    this.node.setPosition(this._startPos);
    this.node.setRotationFromEuler(0,0,0);
    if (this.overlayRight) this.overlayRight.active = false;
    if (this.overlayLeft) this.overlayLeft.active = false;
}
```

}`

------

### 4. å±æ€§å‡çº§ç•Œé¢é€»è¾‘ (`StatsPanel.ts`)

è¿™ä¸ªè„šæœ¬æŒ‚è½½åœ¨â€œMagic Bookâ€ç•Œé¢ä¸Šï¼Œè´Ÿè´£æ•´åˆä»¥ä¸Šé€»è¾‘ã€‚

**â€œ2é€‰1â€çš„å®ç°é€»è¾‘ï¼š** æ—¢ç„¶æ˜¯éšæœºå‡º2ä¸ªé€‰é¡¹è®©ç”¨æˆ·é€‰1ä¸ªï¼Œç»“åˆæ»‘åŠ¨ç©æ³•ï¼Œæˆ‘ä»¬é‡‡å–**â€œæ“‚å°åˆ¶â€**ï¼š

1. å±å¹•åªæ˜¾ç¤º**ä¸€å¼ å¡ç‰‡**ï¼ˆä»£è¡¨é€‰é¡¹Aï¼‰ã€‚
2. **å³æ»‘ (Keep):** æ¥å—é€‰é¡¹Aï¼Œæå‡å¯¹åº”å±æ€§ã€‚
3. **å·¦æ»‘ (Discard):** æ‹’ç»é€‰é¡¹Aï¼Œ**è‡ªåŠ¨è·å¾—é€‰é¡¹B**ï¼ˆè¿™æ˜¯æœ€å¿«èŠ‚å¥çš„åšæ³•ï¼Œæˆ–è€…å·¦æ»‘åæ˜¾ç¤ºé€‰é¡¹Bçš„å¡ç‰‡å†è®©ç”¨æˆ·å³æ»‘ï¼Œå»ºè®®é‡‡ç”¨å‰è€…ï¼šæ‹’ç»Aå³æ¥å—Bï¼Œæˆ–è€…ä»…ä»…æ˜¯Rerollã€‚æ ¹æ®ä½ çš„æè¿°â€œéšæœº2é€‰1â€ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼šå·¦æ»‘å°±æ˜¯é€‰å¦ä¸€ä¸ªï¼‰ã€‚

**ä¿®æ­£é€»è¾‘ï¼š** ä¸ºäº†æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬è®¾å®šâ€”â€”**å·¦æ»‘ = æ”¾å¼ƒå½“å‰æ˜¾ç¤ºçš„ï¼Œè·å–å¤‡é€‰æ–¹æ¡ˆã€‚**

TypeScript

`// assets/Scripts/UI/StatsPanel.ts import { _decorator, Component, Node, Label, instantiate, Prefab } from 'cc'; import { DataManager } from '../Core/DataManager'; import { StatType, StatConfig, UpgradeOption } from '../Data/GameType'; import { SwipeCard } from './SwipeCard'; const { ccclass, property } = _decorator;

@ccclass('StatsPanel') export class StatsPanel extends Component {

```
@property(Label) goldLabel: Label = null!;
@property(Label) costLabel: Label = null!;
@property(Node) cardContainer: Node = null!; // ç”Ÿæˆå¡ç‰‡çš„çˆ¶èŠ‚ç‚¹
@property(Prefab) cardPrefab: Prefab = null!; // å¡ç‰‡é¢„åˆ¶ä½“

// UIåˆ·æ–°
start() {
    this.updateUI();
}

updateUI() {
    this.goldLabel.string = `${DataManager.instance.gold}`;
    this.costLabel.string = `${DataManager.instance.upgradeCost}`;
    // è¿™é‡Œè¿˜éœ€è¦åˆ·æ–°10ä¸ªå±æ€§çš„åˆ—è¡¨æ˜¾ç¤ºï¼ˆç•¥ï¼‰
}

// ç»‘å®šç»™ "UPGRADE" æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
onUpgradeBtnClick() {
    const manager = DataManager.instance;
    if (manager.gold < manager.upgradeCost) {
        console.log("é‡‘å¸ä¸è¶³ï¼");
        // æ’­æ”¾é‡‘å¸ä¸è¶³åŠ¨ç”»
        return;
    }

    // 1. æ‰£é’±
    manager.consumeGold(manager.upgradeCost);
    this.updateUI();

    // 2. ç”Ÿæˆä¸¤ä¸ªéšæœºé€‰é¡¹
    const optionA = this.generateRandomOption();
    let optionB = this.generateRandomOption();
    // ç¡®ä¿Bå’ŒAä¸æ˜¯åŒä¸€ä¸ªå±æ€§ï¼Œä¸ºäº†ä½“éªŒ
    while(optionB.type === optionA.type) {
        optionB = this.generateRandomOption();
    }

    // 3. ç”Ÿæˆå¡ç‰‡å±•ç¤ºé€‰é¡¹A
    this.spawnDecisionCard(optionA, optionB);
}

generateRandomOption(): UpgradeOption {
    // éšæœºå– 0-9
    const typeId = Math.floor(Math.random() * 10);
    const config = StatConfig[typeId];
    return {
        type: typeId,
        value: config.growth // ä½¿ç”¨é…ç½®è¡¨é‡Œçš„æˆé•¿å€¼
    };
}

spawnDecisionCard(optA: UpgradeOption, optB: UpgradeOption) {
    const cardNode = instantiate(this.cardPrefab);
    cardNode.parent = this.cardContainer;
    cardNode.setPosition(0, 0, 0);

    // è®¾ç½®å¡ç‰‡UIå†…å®¹ (Icon, Name, +Value)
    // let script = cardNode.getComponent(StatsCardView);
    // script.render(optA); 

    // ç»‘å®šæ»‘åŠ¨é€»è¾‘
    const swipeCtrl = cardNode.getComponent(SwipeCard);
    
    // ã€å³æ»‘ã€‘ï¼šé€‰æ‹© A
    swipeCtrl.onSwipeRight = () => {
        console.log(`é€‰æ‹©äº†: ${StatConfig[optA.type].name} +${optA.value}`);
        DataManager.instance.addStat(optA.type, optA.value);
        this.updateUI(); // åˆ·æ–°é¢æ¿
    };

    // ã€å·¦æ»‘ã€‘ï¼šæ”¾å¼ƒ Aï¼Œä¹Ÿå°±æ˜¯é€‰æ‹© B (Hidden Option)
    // å¯ä»¥åœ¨å·¦æ»‘æç¤ºUIä¸Šæ˜¾ç¤º "Get [Option B Name]"
    swipeCtrl.onSwipeLeft = () => {
        console.log(`æ”¾å¼ƒAï¼Œè·å¾—äº†: ${StatConfig[optB.type].name} +${optB.value}`);
        DataManager.instance.addStat(optB.type, optB.value);
        this.updateUI();
    };
}
```

}`

------

### ğŸ“ æ‰§è¡Œè®¡åˆ’

**ç°åœ¨ä½ çš„ä»»åŠ¡ï¼š**

1. **åˆ›å»ºé¡¹ç›®ï¼š** æ‰“å¼€ Cocos Creatorï¼Œåˆ›å»ºæ–°é¡¹ç›®ã€‚
2. **åˆ›å»ºè„šæœ¬ï¼š** æŒ‰ç…§ä¸Šé¢çš„ä»£ç å—ï¼Œåœ¨ `assets/Scripts` ä¸‹åˆ›å»ºå¯¹åº”çš„æ–‡ä»¶ã€‚
3. æ­å»ºPrefabï¼š
   - åˆ›å»ºä¸€ä¸ª `Card` Prefabã€‚
   - èƒŒæ™¯å›¾ï¼ˆåœ†è§’çŸ©å½¢ï¼‰ã€‚
   - ä¸­é—´æ”¾ `Icon` (Sprite) å’Œ `Name` (Label)ã€‚
   - æ•°å€¼ `Value` (Labelï¼Œç»¿è‰²)ã€‚
   - æŒ‚è½½ `SwipeCard.ts`ã€‚
   - åœ¨å¡ç‰‡é‡Œåšä¸¤ä¸ªå­èŠ‚ç‚¹ `OverlayRight` (ç»¿è‰²èƒŒæ™¯ï¼Œå†™ç€ KEEP) å’Œ `OverlayLeft` (çº¢è‰²èƒŒæ™¯ï¼Œå†™ç€ SWAP/DISCARD)ï¼Œé»˜è®¤éšè—ã€‚
4. **ç»‘å®šå¼•ç”¨ï¼š** æŠŠ Prefab æ‹–åˆ° `StatsPanel` çš„è„šæœ¬æ§½ä½é‡Œã€‚

### ğŸ“… å¼€å‘é˜¶æ®µäºŒï¼šåœ°å›¾ç”Ÿæˆä¸èŠ‚ç‚¹å¯¼èˆª

### 1. åœ°å›¾æ•°æ®å®šä¹‰ (`MapConfig.ts`)

æˆ‘ä»¬éœ€è¦å®šä¹‰åœ°å›¾ç”±å¤šå°‘å±‚ç»„æˆï¼Œä»¥åŠæ¯ä¸€å±‚å¯èƒ½å‡ºç°ä»€ä¹ˆä¸œè¥¿ã€‚

TypeScript

`// assets/Scripts/Data/MapConfig.ts

export enum NodeType { START = 0,      // èµ·ç‚¹ ENEMY = 1,      // æ™®é€šæˆ˜æ–— (éª·é«…å¤´) CHEST = 2,      // å®ç®±/æˆ˜æ–— (ç®±å­) ELITE = 3,      // ç²¾è‹±æ€ª (å¸¦è§’çš„å¤´) FOUNTAIN = 4,   // æ³‰æ°´ (æŠ€èƒ½å‡çº§) REST = 5,       // çº¢å¿ƒ (å›è¡€) BOSS = 6        // ç»ˆç‚¹ BOSS }

// èŠ‚ç‚¹æ•°æ®ç»“æ„ export interface MapNodeData { id: string;         // å”¯ä¸€ID "layer-index" layerIndex: number; // ç¬¬å‡ å±‚ (Yè½´) index: number;      // è¯¥å±‚çš„ç¬¬å‡ ä¸ª (Xè½´) type: NodeType;     // èŠ‚ç‚¹ç±»å‹ nextIDs: string[];  // è¿æ¥çš„ä¸‹ä¸€å±‚èŠ‚ç‚¹IDåˆ—è¡¨ status: 'LOCKED' | 'AVAILABLE' | 'VISITED'; // çŠ¶æ€ }

// å…³å¡é…ç½® export const LevelConfig = { totalLayers: 15,    // ä¸€ä¸ªç« èŠ‚æœ‰å¤šå°‘å±‚ maxWidth: 3,        // åœ°å›¾æœ€å®½æœ‰å‡ ä¸ªèŠ‚ç‚¹ (å‚è€ƒæˆªå›¾é€šå¸¸æ˜¯2-3ä¸ª) };`

------

### 2. åœ°å›¾ç”Ÿæˆç®—æ³• (`MapGenerator.ts`)

è¿™æ˜¯ä¸€ä¸ªçº¯é€»è¾‘ç±»ï¼Œä¸æ¶‰åŠUIã€‚æˆ‘ä»¬è¦ç”¨ä¸€ä¸ªç®€å•çš„ç®—æ³•ç”Ÿæˆâ€œåˆ†å²”è·¯â€ã€‚ *é€»è¾‘ç­–ç•¥ï¼š* æ¯ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œéšæœºè¿æ¥åˆ°ä¸‹ä¸€å±‚ä¸´è¿‘çš„èŠ‚ç‚¹ã€‚

TypeScript

`// assets/Scripts/Core/MapGenerator.ts import { NodeType, MapNodeData, LevelConfig } from '../Data/MapConfig';

export class MapGenerator {

```
// ç”Ÿæˆæ•´ä¸ªåœ°å›¾æ•°æ®
public static generateMap(): MapNodeData[][] {
    const map: MapNodeData[][] = []; // äºŒç»´æ•°ç»„ï¼š[å±‚][èŠ‚ç‚¹]

    for (let layer = 0; layer < LevelConfig.totalLayers; layer++) {
        const layerNodes: MapNodeData[] = [];
        
        // ç¡®å®šè¿™ä¸€å±‚æœ‰å‡ ä¸ªèŠ‚ç‚¹ (èµ·ç‚¹ç»ˆç‚¹1ä¸ªï¼Œä¸­é—´éšæœº2-3ä¸ª)
        let width = Math.floor(Math.random() * (LevelConfig.maxWidth - 1)) + 2;
        if (layer === 0 || layer === LevelConfig.totalLayers - 1) width = 1;

        for (let i = 0; i < width; i++) {
            layerNodes.push({
                id: `${layer}-${i}`,
                layerIndex: layer,
                index: i,
                type: this.getRandomType(layer),
                nextIDs: [],
                status: layer === 0 ? 'AVAILABLE' : 'LOCKED'
            });
        }
        map.push(layerNodes);
    }

    // å»ºç«‹è¿æ¥ (Link Nodes)
    this.linkNodes(map);
    
    return map;
}

// ç®€å•çš„è¿æ¥é€»è¾‘ï¼šä¸‹ä¸€å±‚çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¿…é¡»è¢«ä¸Šä¸€å±‚è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹è¿æ¥
private static linkNodes(map: MapNodeData[][]) {
    for (let l = 0; l < map.length - 1; l++) {
        const currentLayer = map[l];
        const nextLayer = map[l+1];

        // ç®€å•ç²—æš´è¿æ¥æ³•ï¼š
        // å½“å‰å±‚çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œéšæœºè¿å‘ä¸‹ä¸€å±‚çš„ 1-2 ä¸ªèŠ‚ç‚¹
        // ä¸”ä¿è¯ä¸‹ä¸€å±‚æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰çˆ¶èŠ‚ç‚¹ï¼ˆé˜²æ­¢æ­»è·¯ï¼‰
        
        // ... (æ­¤å¤„çœç•¥å…·ä½“å›¾è®ºè¿æ¥ç®—æ³•ä»£ç ï¼Œæ ¸å¿ƒæ˜¯ç¡®ä¿è·¯å¾„è¿é€š)
        // å®é™…ä¸Šçº¿æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ›´ç®€å•çš„ï¼šå·¦è¿å·¦ï¼Œå³è¿å³ï¼Œä¸­é—´éšæœºã€‚
    }
}

// æ ¹æ®å±‚æ•°æƒé‡éšæœºèŠ‚ç‚¹ç±»å‹
private static getRandomType(layer: number): NodeType {
    if (layer === 0) return NodeType.START;
    if (layer === LevelConfig.totalLayers - 1) return NodeType.BOSS;
    
    const rand = Math.random();
    if (rand < 0.15) return NodeType.FOUNTAIN; // 15% æ³‰æ°´
    if (rand < 0.3) return NodeType.REST;      // 15% å›è¡€
    if (rand < 0.6) return NodeType.CHEST;     // 30% å®ç®±
    return NodeType.ENEMY;                     // 40% æ™®é€šæ€ª
}
```

}`

------

### 3. å•ä¸ªèŠ‚ç‚¹ç»„ä»¶ (`MapNodeView.ts`)

è¿™æ˜¯æŒ‚è½½åœ¨ Prefab ä¸Šçš„è„šæœ¬ï¼Œè´Ÿè´£æ˜¾ç¤ºå›¾æ ‡å’Œå¤„ç†ç‚¹å‡»ã€‚

TypeScript

`// assets/Scripts/UI/MapNodeView.ts import { _decorator, Component, Sprite, SpriteFrame, Node, Button, Color } from 'cc'; import { NodeType, MapNodeData } from '../Data/MapConfig'; const { ccclass, property } = _decorator;

@ccclass('MapNodeView') export class MapNodeView extends Component { @property(Sprite) iconSprite: Sprite = null!; @property(Node) lockMask: Node = null!; // é”å®šçš„é»‘è‰²é®ç½© @property(Node) highlightRing: Node = null!; // å¯é€‰ä¸­çš„å…‰åœˆ

```
// éœ€åœ¨ç¼–è¾‘å™¨ç»‘å®šä¸€ç»„ SpriteFrame
@property([SpriteFrame]) iconFrames: SpriteFrame[] = []; 

public data: MapNodeData = null!;
public callback: (nodeData: MapNodeData) => void = null!;

init(data: MapNodeData, cb: any) {
    this.data = data;
    this.callback = cb;

    // 1. è®¾ç½®å›¾æ ‡ (æ ¹æ® NodeType æšä¸¾å¯¹åº” SpriteFrame)
    this.iconSprite.spriteFrame = this.iconFrames[data.type];

    // 2. è®¾ç½®çŠ¶æ€æ ·å¼
    this.updateState();
}

updateState() {
    this.lockMask.active = this.data.status === 'LOCKED';
    this.highlightRing.active = this.data.status === 'AVAILABLE';
    
    // å¦‚æœæ˜¯å·²è®¿é—®ï¼Œå˜ç°æˆ–è€…æ‰“å‹¾
    if (this.data.status === 'VISITED') {
        this.iconSprite.color = Color.GRAY;
    }
}

onClick() {
    if (this.data.status === 'AVAILABLE') {
        this.callback(this.data);
    } else {
        console.log("å¤ªè¿œäº†ï¼Œèµ°ä¸åˆ°é‚£é‡Œï¼");
    }
}
```

}`

------

### 4. åœ°å›¾ç®¡ç†å™¨ä¸ç”»çº¿ (`MapManager.ts`)

è¿™æ˜¯æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œè´Ÿè´£æŠŠèŠ‚ç‚¹ç”»å‡ºæ¥ï¼Œå¹¶ç”¨çº¿æ¡è¿æ¥å®ƒä»¬ã€‚

**å®ç°æŠ€å·§ï¼š**

- ä½¿ç”¨ `cc.Graphics` ç»„ä»¶æ¥ç”»é»‘è‰²çš„è¿æ¥çº¿ï¼ˆå‚è€ƒå›¾4ä¸­çš„é»‘çº¿ï¼‰ã€‚
- åˆ©ç”¨ `ScrollView` æˆ–è€…ç®€å•çš„ `Node` å®¹å™¨ï¼Œå› ä¸ºåœ°å›¾å¾ˆé•¿ï¼Œéœ€è¦æ»šåŠ¨ã€‚

TypeScript

`// assets/Scripts/Core/MapManager.ts import { _decorator, Component, Node, Prefab, instantiate, Graphics, UITransform, Vec3, tween } from 'cc'; import { MapGenerator } from './MapGenerator'; import { MapNodeData, NodeType } from '../Data/MapConfig'; import { MapNodeView } from '../UI/MapNodeView'; const { ccclass, property } = _decorator;

@ccclass('MapManager') export class MapManager extends Component {

```
@property(Node) container: Node = null!; // æ‰€æœ‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹
@property(Prefab) nodePrefab: Prefab = null!;
@property(Graphics) lineDrawer: Graphics = null!; // ç”¨äºç”»çº¿çš„ç»„ä»¶
@property(Node) playerAvatar: Node = null!; // ç©å®¶å¤´åƒå°äºº

private mapData: MapNodeData[][] = [];
private nodeViews: Map[string, Node] = new Map(); // ç¼“å­˜èŠ‚ç‚¹ ID -> Node

// å¸ƒå±€é…ç½®
private layerHeight: number = 150; // å±‚é—´è· Y
private nodeSpacing: number = 120; // èŠ‚ç‚¹é—´è· X

start() {
    this.generateAndDraw();
}

generateAndDraw() {
    this.mapData = MapGenerator.generateMap();
    this.lineDrawer.clear();

    // éå†æ•°æ®ç”ŸæˆèŠ‚ç‚¹
    this.mapData.forEach((layerNodes, layerIndex) => {
        const layerY = layerIndex * this.layerHeight;

        layerNodes.forEach((nodeData, i) => {
            // è®¡ç®— X åæ ‡ï¼šå±…ä¸­æ’åˆ—
            // å¦‚æœè¯¥å±‚æœ‰3ä¸ªï¼šx = (i - 1) * spacing
            const startX = -((layerNodes.length - 1) * this.nodeSpacing) / 2;
            const nodeX = startX + i * this.nodeSpacing;

            // 1. ç”ŸæˆèŠ‚ç‚¹ UI
            const nodeObj = instantiate(this.nodePrefab);
            nodeObj.parent = this.container;
            nodeObj.setPosition(nodeX, layerY, 0);
            
            const view = nodeObj.getComponent(MapNodeView);
            view.init(nodeData, this.onNodeSelected.bind(this));
            
            this.nodeViews.set(nodeData.id, nodeObj);

            // 2. ç”»çº¿ (è¿æ¥åˆ°ä¸‹ä¸€å±‚)
            // è¿™é‡Œéœ€è¦ç­‰ä¸‹ä¸€å±‚ç”Ÿæˆå®Œæ‰èƒ½ç”»ï¼Œæˆ–è€…åœ¨æ•°æ®å±‚å¤„ç†ã€‚
            // ç®€åŒ–é€»è¾‘ï¼šæˆ‘ä»¬ç›´æ¥éå† mapData çš„è¿æ¥å…³ç³»æ¥ç”»çº¿
        });
    });

    this.drawConnections();
    
    // æ”¾ç½®ç©å®¶åœ¨èµ·ç‚¹
    this.movePlayerToNode(this.mapData[0][0]);
}

drawConnections() {
    this.lineDrawer.lineWidth = 5;
    this.lineDrawer.strokeColor.fromHEX('#333333'); // é»‘è‰²è¿æ¥çº¿

    this.mapData.forEach(layer => {
        layer.forEach(node => {
            const startNode = this.nodeViews.get(node.id);
            // éå†å®ƒçš„å­èŠ‚ç‚¹
            // æ³¨æ„ï¼šç”Ÿæˆå™¨é‡Œè¦æœ‰ nextIDs æ•°æ®
            // è¿™é‡Œå‡è®¾æˆ‘ä»¬å·²ç»æœ‰äº†è¿æ¥é€»è¾‘
        });
    });
}

// ç©å®¶ç‚¹å‡»èŠ‚ç‚¹åçš„æ ¸å¿ƒé€»è¾‘
onNodeSelected(targetNode: MapNodeData) {
    console.log(`å‰å¾€èŠ‚ç‚¹: å±‚çº§ ${targetNode.layerIndex}, ç±»å‹ ${NodeType[targetNode.type]}`);

    // 1. ç©å®¶ç§»åŠ¨åŠ¨ç”»
    this.movePlayerToNode(targetNode);

    // 2. æ›´æ–°åœ°å›¾çŠ¶æ€
    this.updateMapStatus(targetNode);

    // 3. è§¦å‘äº‹ä»¶ (å»¶è¿Ÿä¸€ç‚¹ï¼Œç­‰å°äººèµ°åˆ°)
    this.scheduleOnce(() => {
        this.triggerEvent(targetNode.type);
    }, 0.5);
}

movePlayerToNode(nodeData: MapNodeData) {
    const targetPos = this.nodeViews.get(nodeData.id).position;
    
    // ç©å®¶è·³è¿‡å»
    tween(this.playerAvatar)
        .to(0.5, { position: new Vec3(targetPos.x, targetPos.y + 50, 0) }, { easing: 'cubicOut' }) // y+50 ç«™åœ¨èŠ‚ç‚¹ä¸Šæ–¹
        .start();
    
    // åœ°å›¾å®¹å™¨ä¸‹ç§»ï¼Œæ¨¡æ‹Ÿæ‘„åƒæœºè·Ÿéš
    // ä¿æŒç©å®¶åœ¨å±å¹•åä¸‹æ–¹ä½ç½®
    const cameraY = -targetPos.y - 200; 
    tween(this.container)
        .to(0.5, { position: new Vec3(0, cameraY, 0) })
        .start();
}

triggerEvent(type: NodeType) {
    switch(type) {
        case NodeType.CHEST:
        case NodeType.ENEMY:
            // TODO: åŠ è½½æˆ˜æ–—åœºæ™¯ (Battle Scene)
            console.log("è¿›å…¥æˆ˜æ–—åœºæ™¯...");
            break;
        case NodeType.FOUNTAIN:
            // TODO: å¼¹å‡ºæŠ€èƒ½ä¸‰é€‰ä¸€ UI
            console.log("æ‰“å¼€æŠ€èƒ½é€‰æ‹©å¼¹çª—...");
            break;
        case NodeType.REST:
            // TODO: ç›´æ¥å›è¡€å¹¶å¼¹æç¤º
            console.log("æ¢å¤ HP!");
            break;
    }
}

updateMapStatus(currentNode: MapNodeData) {
    // é€»è¾‘ï¼š
    // 1. æŠŠå½“å‰å±‚æ‰€æœ‰èŠ‚ç‚¹è®¾ä¸º VISITED (æˆ–ä¸å¯é€‰)
    // 2. æ ¹æ® currentNode.nextIDsï¼ŒæŠŠä¸‹ä¸€å±‚è¿æ¥çš„èŠ‚ç‚¹è®¾ä¸º AVAILABLE
    // 3. å…¶ä»–è®¾ä¸º LOCKED
    // 4. åˆ·æ–°æ‰€æœ‰ NodeView
}
```

}`

------

### ğŸ”¨ ä½ çš„å¼€å‘ä»»åŠ¡æ¸…å• (Phase 2)

ç°åœ¨è¯·æ‰“å¼€ä½ çš„ IDEï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. èµ„æºå‡†å¤‡ï¼š
   - æ‰¾å‡ ä¸ªå›¾æ ‡åˆ†åˆ«ä»£è¡¨ï¼šæ——å¸œ(Start)ã€éª·é«…(Enemy)ã€å®ç®±(Chest)ã€æ³‰æ°´/æ°´æ± (Fountain)ã€çº¢å¿ƒ(Rest)ã€‚
   - å³ä½¿å…ˆç”¨ç®€å•çš„è‰²å—ï¼ˆçº¢æ–¹å—ã€è“åœ†åœˆï¼‰ä»£æ›¿ä¹Ÿæ²¡é—®é¢˜ï¼Œé€»è¾‘æœ€é‡è¦ã€‚
2. åˆ›å»º Prefab (`NodePrefab`):
   - æ ¹èŠ‚ç‚¹å°ºå¯¸ 80x80ã€‚
   - å­èŠ‚ç‚¹ `Sprite` (Icon)ã€‚
   - å­èŠ‚ç‚¹ `Highlight` (ä¸€ä¸ªå…‰åœˆå›¾ç‰‡ï¼Œé»˜è®¤éšè—)ã€‚
   - å­èŠ‚ç‚¹ `LockMask` (åŠé€æ˜é»‘è‰² Spriteï¼Œé»˜è®¤éšè—)ã€‚
   - æŒ‚è½½ `MapNodeView.ts`ã€‚
3. æ­å»ºåœ°å›¾åœºæ™¯ (`AdventureScene`):
   - åˆ›å»ºä¸€ä¸ª `Canvas`ã€‚
   - åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ `MapContainer`ã€‚
   - åœ¨ `MapContainer` ä¸‹æ–¹æ”¾ä¸€ä¸ª `Graphics` èŠ‚ç‚¹ï¼ˆç”¨äºç”»çº¿ï¼‰ã€‚
   - åˆ›å»ºä¸€ä¸ªå°äººèŠ‚ç‚¹ `PlayerAvatar`ï¼ˆæ”¾åœ¨ MapContainer é‡Œé¢æˆ–å¤–é¢è·Ÿéšï¼‰ã€‚
   - å°† `MapManager.ts` æŒ‚è½½åœ¨ Canvas ä¸Šï¼Œå¹¶æŠŠä¸Šè¿°èŠ‚ç‚¹æ‹–è¿›å»å¼•ç”¨ã€‚
4. æµ‹è¯•è¿è¡Œï¼š
   - è¿è¡Œæ¸¸æˆï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ã€ä»ä¸‹å¾€ä¸Šå»¶ä¼¸çš„èŠ‚ç‚¹æ ‘ã€‚
   - ç‚¹å‡»ç¬¬ä¸€å±‚çš„èŠ‚ç‚¹ï¼Œå°äººåº”è¯¥ä¼šè·³è¿‡å»ï¼Œæ§åˆ¶å°æ‰“å° "è§¦å‘äº‹ä»¶..."ã€‚

### ğŸ“… å¼€å‘é˜¶æ®µä¸‰ï¼šæˆ˜æ–—ã€æ‰è½ä¸è£…å¤‡æ„å»º

### 1. è£…å¤‡æ•°æ®ç»“æ„ (`Equipment.ts`)

é¦–å…ˆï¼Œæˆ‘ä»¬è¦å®šä¹‰â€œè£…å¤‡â€é•¿ä»€ä¹ˆæ ·ã€‚å®ƒæ¯”å±æ€§å¤æ‚ï¼Œå› ä¸ºå®ƒæœ‰éƒ¨ä½ã€å“è´¨å’Œéšæœºè¯æ¡ã€‚

TypeScript

`// assets/Scripts/Data/Equipment.ts import { StatType } from './GameType';

export enum Rarity { Common = 0,   // ç™½ Uncommon = 1, // ç»¿ Rare = 2,     // è“ Epic = 3,     // ç´« Legendary = 4 // æ©™ }

export enum SlotType { Weapon = 0, Armor = 1, Helmet = 2, Boots = 3, Accessory1 = 4, Accessory2 = 5, Offhand = 6, Special = 7 }

export interface EquipmentData { uid: string;           // å”¯ä¸€ID id: number;            // é…ç½®è¡¨ID (ç”¨äºæŸ¥æ‰¾å›¾æ ‡/åç§°) name: string; slot: SlotType; rarity: Rarity; level: number;         // ç‰©å“ç­‰çº§ (è·Ÿéšå…³å¡)

```
// æ ¸å¿ƒå±æ€§
stats: { type: StatType, value: number }[]; 

// è§†è§‰èµ„æº
iconPath: string;
```

}

export class EquipmentGenerator { // æ ¸å¿ƒç®—æ³•ï¼šæ ¹æ®å…³å¡ç­‰çº§ç”Ÿæˆä¸€ä»¶éšæœºè£…å¤‡ static generate(level: number): EquipmentData { // 1. éšæœºéƒ¨ä½ const slot = Math.floor(Math.random() * 8);

```
    // 2. éšæœºå“è´¨ (æ ¹æ®æƒé‡)
    const rarity = this.rollRarity();
    
    // 3. ç”Ÿæˆå±æ€§ (å“è´¨è¶Šé«˜ï¼Œè¯æ¡è¶Šå¤š/æ•°å€¼è¶Šé«˜)
    const stats = [];
    // ä¸»å±æ€§ (ä¾‹å¦‚æ­¦å™¨å¿…å¸¦æ”»å‡»ï¼Œè¡£æœå¿…å¸¦è¡€é‡)
    if (slot === SlotType.Weapon) stats.push({ type: StatType.Damage, value: level * 2 + 5 });
    if (slot === SlotType.Armor)  stats.push({ type: StatType.Health, value: level * 20 + 50 });
    
    // å‰¯å±æ€§ (éšæœº)
    // ... (æ­¤å¤„çœç•¥éšæœºç®—æ³•)

    return {
        uid: `${Date.now()}-${Math.random()}`,
        id: 1001, // å ä½
        name: "Iron Sword",
        slot: slot,
        rarity: rarity,
        level: level,
        stats: stats,
        iconPath: `icon_gear_${slot}`
    };
}

static rollRarity(): Rarity {
    const r = Math.random();
    if (r < 0.05) return Rarity.Legendary;
    if (r < 0.20) return Rarity.Rare;
    return Rarity.Common;
}
```

}`

------

### 2. è£…å¤‡ç®¡ç†å™¨ (`InventoryManager.ts`)

è¿™ä¸ªç±»è´Ÿè´£ç®¡ç†é‚£ **8ä¸ªæ§½ä½**ï¼Œå¹¶è®¡ç®—ç©¿ä¸Šè£…å¤‡åçš„**æ€»å±æ€§åŠ æˆ**ã€‚

TypeScript

`// assets/Scripts/Core/InventoryManager.ts import { _decorator, Component } from 'cc'; import { EquipmentData, SlotType } from '../Data/Equipment'; import { DataManager } from './DataManager';

export class InventoryManager { private static _instance: InventoryManager; public static get instance() { return this._instance || (this._instance = new InventoryManager()); }

```
// 8ä¸ªæ§½ä½ï¼Œåˆå§‹ä¸ºç©º
public slots: Map<SlotType, EquipmentData> = new Map();

// ç©¿æˆ´è£…å¤‡
public equip(newGear: EquipmentData) {
    this.slots.set(newGear.slot, newGear);
    this.recalculateTotalStats();
}

// è·å–å½“å‰æ§½ä½çš„è£…å¤‡ (ç”¨äºå¯¹æ¯”)
public getEquipInSlot(slot: SlotType): EquipmentData | null {
    return this.slots.get(slot) || null;
}

// é‡æ–°è®¡ç®—æ‰€æœ‰è£…å¤‡çš„å±æ€§æ€»å’Œï¼Œå¹¶æ›´æ–°åˆ° DataManager
private recalculateTotalStats() {
    // 1. é‡ç½®ä¸ºè£¸ä½“å±æ€§ (Base Stats)
    // 2. éå† slots ç´¯åŠ å±æ€§
    // 3. DataManager.instance.updateBattleStats(finalStats);
}
```

}`

------

### 3. æˆ˜æ–—æ ¸å¿ƒé€»è¾‘ (`BattleManager.ts`)

è¿™é‡Œæˆ‘ä»¬è¦æ¨¡æ‹Ÿâ€œç¬¬ä¸€äººç§°â€çš„è§†è§‰æ•ˆæœã€‚ **è§†è§‰æ¬ºéª—æŠ€å·§ï¼š**

- **å‰è¿›ï¼š** åœ°é¢çº¹ç†æ»šåŠ¨ï¼ˆShaderæˆ–ç§»åŠ¨UVï¼‰ã€‚
- **é‡æ€ªï¼š** æ€ªç‰© Sprite ä»å±å¹•ä¸­å¿ƒæå°ï¼ˆscale=0.1ï¼‰é€æ¸æ”¾å¤§åˆ°æ­£å¸¸å¤§å°ï¼ˆscale=1.0ï¼‰ï¼Œå¹¶åœ¨ Y è½´å‘ä¸‹ç§»åŠ¨ï¼Œæ¨¡æ‹Ÿâ€œèµ°è¿‘â€çš„æ„Ÿè§‰ã€‚

TypeScript

`// assets/Scripts/Core/BattleManager.ts import { _decorator, Component, Node, Sprite, Label, Tween, tween, Vec3 } from 'cc'; import { EquipmentGenerator } from '../Data/Equipment'; import { SwipeCard } from '../UI/SwipeCard'; import { InventoryManager } from './InventoryManager'; import { ComparePanel } from '../UI/ComparePanel'; // ä¸‹é¢ä¼šè®²

@ccclass('BattleManager') export class BattleManager extends Component { @property(Node) enemyNode: Node = null!; // æ€ªç‰©èŠ‚ç‚¹ @property(Node) weaponHand: Node = null!; // ç©å®¶çš„æ‰‹/æ­¦å™¨ @property(ComparePanel) comparePanel: ComparePanel = null!; // è£…å¤‡å¯¹æ¯”å¼¹çª—

```
private isFighting: boolean = false;

start() {
    this.spawnEnemy();
}

// 1. ç”Ÿæˆæ€ªç‰©å¹¶â€œèµ°è¿‘â€
spawnEnemy() {
    this.enemyNode.active = true;
    this.enemyNode.setScale(0.1, 0.1);
    this.enemyNode.setPosition(0, 100); // è¿œå¤„åœ°å¹³çº¿ä½ç½®

    // æ¨¡æ‹Ÿèµ°è¿‘åŠ¨ç”»
    tween(this.enemyNode)
        .to(1.5, { scale: new Vec3(1, 1, 1), position: new Vec3(0, -100, 0) })
        .call(() => {
            this.startCombat();
        })
        .start();
}

// 2. è‡ªåŠ¨æˆ˜æ–—å¾ªç¯
startCombat() {
    this.isFighting = true;
    // å¼€å¯ä¸€ä¸ªè®¡æ—¶å™¨ï¼ŒæŒ‰æ”»é€Ÿé¢‘ç‡é€ æˆä¼¤å®³
    this.schedule(this.playerAttack, 1.0); // å‡è®¾1ç§’æ‰“ä¸€ä¸‹
}

playerAttack() {
    // æ’­æ”¾æ‰‹éƒ¨æ”»å‡»åŠ¨ç”» (Punch / Swing)
    tween(this.weaponHand)
        .by(0.1, { position: new Vec3(0, 50, 0) })
        .by(0.1, { position: new Vec3(0, -50, 0) })
        .start();

    // æ‰£é™¤æ€ªç‰©è¡€é‡... (ç®€åŒ–)
    // CheckDead()...
    this.onEnemyDie();
}

// 3. æˆ˜æ–—èƒœåˆ©ï¼Œæ‰è½è£…å¤‡
onEnemyDie() {
    this.isFighting = false;
    this.unschedule(this.playerAttack);
    this.enemyNode.active = false;

    // ç”Ÿæˆæ‰è½ç‰©
    const newGear = EquipmentGenerator.generate(1); // å‡è®¾ç­‰çº§1
    const currentGear = InventoryManager.instance.getEquipInSlot(newGear.slot);

    // å”¤èµ·æ ¸å¿ƒäº¤äº’ï¼šå¯¹æ¯”é¢æ¿
    this.comparePanel.show(newGear, currentGear, () => {
        // Callback: å¤„ç†å®Œè£…å¤‡åï¼Œå»ä¸‹ä¸€ä¸ªæ€ª
        this.spawnEnemy();
    });
}
```

}`

------

### 4. æ ¸å¿ƒäº¤äº’UIï¼šè£…å¤‡å¯¹æ¯”é¢æ¿ (`ComparePanel.ts`)

è¿™å°±æ˜¯ **[å›¾5]** çš„å¤ç°ã€‚ **ç—›ç‚¹è§£å†³ï¼š** ç©å®¶éœ€è¦åœ¨ä¸€ç§’é’Ÿå†…å†³å®šâ€œæ¢â€è¿˜æ˜¯â€œå–â€ã€‚æ‰€ä»¥å¿…é¡»ç›´è§‚æ˜¾ç¤º**å±æ€§å˜åŒ– (Diff)**ã€‚

TypeScript

`// assets/Scripts/UI/ComparePanel.ts import { _decorator, Component, Node, Label, Color, instantiate, Prefab } from 'cc'; import { EquipmentData } from '../Data/Equipment'; import { SwipeCard } from './SwipeCard'; import { InventoryManager } from '../Core/InventoryManager'; import { DataManager } from '../Core/DataManager';

@ccclass('ComparePanel') export class ComparePanel extends Component { @property(Node) container: Node = null!; @property(Prefab) cardPrefab: Prefab = null!; // ä½ çš„å¡ç‰‡é¢„åˆ¶ä½“

```
private _onClose: Function = null!;

public show(newGear: EquipmentData, oldGear: EquipmentData | null, onClose: Function) {
    this.node.active = true;
    this._onClose = onClose;

    // 1. ç”Ÿæˆå¡ç‰‡
    const cardNode = instantiate(this.cardPrefab);
    cardNode.parent = this.container;
    cardNode.setPosition(0,0);

    // 2. å¡«å……å¡ç‰‡å†…å®¹ (è¿™é‡Œæ˜¯å…³é”®)
    // æˆ‘ä»¬éœ€è¦åœ¨å¡ç‰‡ä¸Šæ˜¾ç¤º New Gear çš„å±æ€§ï¼Œ
    // åŒæ—¶åœ¨æ—è¾¹æˆ–è€…ä¸‹æ–¹ç”¨ (+5) (ç»¿) æˆ– (-2) (çº¢) æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
    this.renderCardContent(cardNode, newGear, oldGear);

    // 3. ç»‘å®šæ»‘åŠ¨é€»è¾‘
    const swipe = cardNode.getComponent(SwipeCard);
    
    // å³æ»‘ï¼šç©¿æˆ´ (Equip)
    swipe.onSwipeRight = () => {
        InventoryManager.instance.equip(newGear);
        // æ—§è£…å¤‡å–æ‰æ¢é’± (å¯é€‰é€»è¾‘)
        this.close();
    };

    // å·¦æ»‘ï¼šå‡ºå”® (Sell)
    swipe.onSwipeLeft = () => {
        DataManager.instance.gold += 50; // å–å‡ºä»·æ ¼
        this.close();
    };
}

renderCardContent(node: Node, newGear: EquipmentData, oldGear: EquipmentData) {
    // ä¼ªä»£ç ï¼šè·å–Labelç»„ä»¶
    // node.getChildByName("Name").getComponent(Label).string = newGear.name;
    
    // å¯¹æ¯”æ˜¾ç¤ºé€»è¾‘
    newGear.stats.forEach(stat => {
        // æ‰¾æ—§è£…å¤‡é‡Œæœ‰æ²¡æœ‰åŒç±»å±æ€§
        const oldVal = oldGear ? (oldGear.stats.find(s => s.type === stat.type)?.value || 0) : 0;
        const diff = stat.value - oldVal;
        
        // å¦‚æœ diff > 0ï¼Œæ˜¾ç¤ºç»¿è‰²ç®­å¤´ï¼›diff < 0ï¼Œæ˜¾ç¤ºçº¢è‰²ç®­å¤´
        // UIå±•ç¤ºå½¢å¼ï¼š "Damage: 25 (+5)"
    });
}

close() {
    this.node.active = false;
    if (this._onClose) this._onClose();
}
```

}`

------

### ğŸ¨ ç¾æœ¯ä¸UIå¸ƒå±€å»ºè®® (é’ˆå¯¹å›¾5)

ä¸ºäº†è¿˜åŸæˆªå›¾çš„æ•ˆæœï¼Œä½ åœ¨åˆ¶ä½œ `CardPrefab` æ—¶è¯·æ³¨æ„ï¼š

1. å¸ƒå±€ï¼š
   - å¡ç‰‡æ˜¯ç«–é•¿æ–¹å½¢ï¼Œå æ®å±å¹•ä¸­å¤®ã€‚
   - **ä¸ŠåŠéƒ¨åˆ†ï¼š** è£…å¤‡å›¾æ ‡ï¼ˆå¤§å›¾ï¼‰ã€‚
   - **ä¸‹åŠéƒ¨åˆ†ï¼š** å±æ€§åˆ—è¡¨ã€‚
2. è§†è§‰é”šç‚¹ï¼š
   - **å·¦ä¾§å±å¹•è¾¹ç¼˜ï¼š** æ”¾ä¸€ä¸ªåŠé€æ˜çš„é‡‘å¸å›¾æ ‡/åƒåœ¾æ¡¶å›¾æ ‡ï¼ˆæš—ç¤ºå·¦æ»‘æ˜¯å–ï¼‰ã€‚
   - **å³ä¾§å±å¹•è¾¹ç¼˜ï¼š** æ”¾ä¸€ä¸ªåŠé€æ˜çš„èƒŒåŒ…/ç©¿æˆ´å›¾æ ‡ï¼ˆæš—ç¤ºå³æ»‘æ˜¯ç©¿ï¼‰ã€‚
3. å¯¹æ¯”æ˜¾ç¤º (Diff View)ï¼š
   - è¿™æ˜¯æœ€é‡è¦çš„ä½“éªŒã€‚ä¸è¦åªæ˜¾ç¤ºæ–°è£…å¤‡æ•°å€¼ã€‚
   - å»ºè®®æ ¼å¼ï¼š`æ”»å‡»åŠ› 150` `(â¬†ï¸ 20)` (ç»¿è‰²é«˜äº®)ã€‚
   - å¦‚æœæ˜¯æ–°è£…å¤‡æœ‰ä½†æ—§è£…å¤‡æ²¡æœ‰çš„å±æ€§ï¼Œæ˜¾ç¤º `NEW!` æ ‡ç­¾ã€‚

### ğŸš€ æ‰§è¡Œä»»åŠ¡ (Phase 3)

1. **å®Œå–„æ•°æ®å±‚ï¼š** åˆ›å»º `Equipment.ts` å’Œ `InventoryManager.ts`ã€‚
2. **åˆ¶ä½œè£…å¤‡å¡ç‰‡ UIï¼š** ä¿®æ”¹ä¹‹å‰çš„ `Card` Prefabï¼Œå¢åŠ å±æ€§å¯¹æ¯”çš„ Labelï¼ˆç»¿/çº¢é¢œè‰²é€»è¾‘ï¼‰ã€‚
3. æ­å»ºæˆ˜æ–—åœºæ™¯ï¼š
   - åªéœ€è¦ä¸€ä¸ªèƒŒæ™¯å›¾ã€ä¸€ä¸ªæ‰‹éƒ¨ Spriteã€ä¸€ä¸ªæ•Œäºº Spriteã€‚
   - æŠŠ `BattleManager` æŒ‚ä¸Šå»ã€‚
4. è”è°ƒï¼š
   - è¿è¡Œ -> æ€ªç‰©å˜å¤§èµ°è¿‘ -> æ€ªç‰©æ¶ˆå¤± -> **å¼¹å‡ºå¡ç‰‡** -> æ»‘åŠ¨ -> ç»§ç»­å‡ºæ€ªã€‚

è¿™å¥—é€»è¾‘ä¸€æ—¦è·‘é€šï¼Œä½ çš„æ¸¸æˆ Demo å°±å·²ç»å…·å¤‡äº†æ ¸å¿ƒå¯ç©æ€§ï¼åŠ æ²¹ï¼ŒåŠ¨æ‰‹å§ï¼

### ğŸ“… å¼€å‘é˜¶æ®µå››ï¼šè‚‰é¸½æŠ€èƒ½ç³»ç»Ÿ (Roguelike Skills)

è¿™æ˜¯å¯¹åº” **[å›¾3] (Pick an ability)** çš„åŠŸèƒ½ã€‚å½“ç©å®¶åˆ°è¾¾ **"Fountain" (æ³‰æ°´)** èŠ‚ç‚¹æˆ–å‡çº§æ—¶è§¦å‘ã€‚ æŠ€èƒ½ä¸è£…å¤‡ä¸åŒï¼Œå®ƒä»¬é€šå¸¸æ˜¯è¢«åŠ¨æ•ˆæœï¼ˆPassive Effectsï¼‰ï¼Œéœ€è¦ç›‘å¬æˆ˜æ–—äº‹ä»¶ã€‚

### 1. æŠ€èƒ½æ•°æ®ç»“æ„ (`Skill.ts`)

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªçµæ´»çš„äº‹ä»¶è§¦å‘æœºåˆ¶ã€‚

TypeScript

`// assets/Scripts/Data/Skill.ts

export enum TriggerType { ON_ATTACK = 'ON_ATTACK',       // æ”»å‡»æ—¶è§¦å‘ (å¦‚ï¼šé€ æˆé¢å¤–ä¼¤å®³) ON_HIT = 'ON_HIT',             // å‘½ä¸­åè§¦å‘ (å¦‚ï¼šå¸è¡€) ON_TAKE_DAMAGE = 'ON_TAKE_DAMAGE', // å—å‡»æ—¶è§¦å‘ (å¦‚ï¼šåä¼¤) ON_KILL = 'ON_KILL',           // å‡»æ€æ—¶è§¦å‘ (å¦‚ï¼šå›è¡€) PASSIVE_STAT = 'PASSIVE_STAT'  // çº¯å±æ€§åŠ æˆ (å¦‚ï¼šæ”»å‡»åŠ›+10%) }

export interface SkillData { id: number; name: string; desc: string; icon: string; rarity: number;

```
// æ ¸å¿ƒé€»è¾‘é…ç½®
trigger: TriggerType;
chance: number;      // è§¦å‘æ¦‚ç‡ (0-1)
value: number;       // æ•°å€¼å‚æ•° (ä¼¤å®³å€ç‡/å›å¤é‡ç­‰)
cooldown?: number;   // å†·å´æ—¶é—´
```

}

export const SkillDatabase: SkillData[] = [ { id: 101, name: "Lightning", desc: "10% chance to unleash lightning dealing 100% damage.", icon: "skill_lightning", rarity: 2, trigger: TriggerType.ON_ATTACK, chance: 0.1, value: 1.0 }, { id: 102, name: "Healing Strike", desc: "5% chance to Heal 5% HP on attack.", icon: "skill_heal", rarity: 2, trigger: TriggerType.ON_ATTACK, chance: 0.05, value: 0.05 } ];`

### 2. æŠ€èƒ½ç®¡ç†å™¨ä¸äº‹ä»¶ç›‘å¬ (`SkillManager.ts`)

è¿™ä¸ªç®¡ç†å™¨éœ€è¦åœ¨æˆ˜æ–—ä¸­â€œæ—å¬â€ã€‚

TypeScript

`// assets/Scripts/Core/SkillManager.ts import { _decorator } from 'cc'; import { SkillData, TriggerType } from '../Data/Skill'; import { BattleManager } from './BattleManager'; // å‡è®¾æœ‰å¼•ç”¨ import { DataManager } from './DataManager';

export class SkillManager { private static _instance: SkillManager; public static get instance() { return this._instance || (this._instance = new SkillManager()); }

```
public learnedSkills: SkillData[] = [];

// å­¦ä¹ æ–°æŠ€èƒ½
public learnSkill(skill: SkillData) {
    this.learnedSkills.push(skill);
    console.log(`Learned skill: ${skill.name}`);
    
    // å¦‚æœæ˜¯ç›´æ¥åŠ å±æ€§çš„è¢«åŠ¨ï¼Œç«‹å³ç”Ÿæ•ˆ
    if (skill.trigger === TriggerType.PASSIVE_STAT) {
        // DataManager.instance.addBonusStats(...)
    }
}

// æ ¸å¿ƒï¼šæˆ˜æ–—äº‹ä»¶è§¦å‘å™¨
// BattleManager åœ¨æ”»å‡»æ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š SkillManager.instance.onEvent(TriggerType.ON_ATTACK, context)
public onEvent(trigger: TriggerType, context: any) {
    this.learnedSkills.forEach(skill => {
        if (skill.trigger === trigger) {
            this.tryTriggerSkill(skill, context);
        }
    });
}

private tryTriggerSkill(skill: SkillData, context: any) {
    if (Math.random() < skill.chance) {
        this.executeEffect(skill, context);
    }
}

private executeEffect(skill: SkillData, context: any) {
    console.log(`Triggered Skill: ${skill.name}!`);
    
    // æ ¹æ®æŠ€èƒ½IDæˆ–ç±»å‹å†™å…·ä½“é€»è¾‘
    // å®é™…å¼€å‘ä¸­å»ºè®®ä½¿ç”¨ Commandæ¨¡å¼ æˆ– ç‹¬ç«‹çš„ Effect ç±»
    switch (skill.id) {
        case 101: // Lightning
            // context.enemy.takeDamage(playerDmg * skill.value);
            // PlayEffect("LightningFX");
            break;
        case 102: // Healing
            // context.player.heal(maxHp * skill.value);
            // PlayEffect("HealFX");
            break;
    }
}
```

}`

### 3. æŠ€èƒ½é€‰æ‹© UI (`AbilityDraftPanel.ts`)

å¯¹åº” **[å›¾3]** çš„ä¸‰é€‰ä¸€ç•Œé¢ã€‚

- **æ³¨æ„ç»†èŠ‚**ï¼šæˆªå›¾åº•éƒ¨æœ‰ä¸€ä¸ª **"TAKE ALL!" (è§†é¢‘å¹¿å‘Šå›¾æ ‡)**ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å˜ç°ç‚¹ï¼Œå…è®¸ç©å®¶çœ‹å¹¿å‘Šå…¨æ‹¿ã€‚

TypeScript

`// assets/Scripts/UI/AbilityDraftPanel.ts // é€»è¾‘ä¸ AttributeUpgrade ç±»ä¼¼ï¼Œä½†è¿™é‡Œæ˜¯ç‚¹å‡»é€‰æ‹©ï¼Œä¸æ˜¯æ»‘åŠ¨ï¼ˆæ ¹æ®å›¾3çš„æŒ‰é’®å¸ƒå±€ï¼‰

export class AbilityDraftPanel extends Component { @property([Node]) cardSlots: Node[] = []; // 3ä¸ªå¡ç‰‡èŠ‚ç‚¹ @property(Node) takeAllBtn: Node = null!;

```
public show() {
    this.node.active = true;
    // 1. éšæœºå‡º3ä¸ªä¸é‡å¤æŠ€èƒ½
    const options = this.getRandomSkills(3);
    
    // 2. æ¸²æŸ“å¡ç‰‡
    options.forEach((skill, index) => {
        // Setup Card UI (Icon, Desc, Name)
        // Bind Click Event -> selectSkill(skill)
    });

    // 3. ç»‘å®š "Take All" å¹¿å‘ŠæŒ‰é’®
    this.takeAllBtn.on('click', () => {
        // AdManager.showVideo(() => {
        //    options.forEach(s => SkillManager.instance.learnSkill(s));
        //    this.close();
        // });
    });
}

selectSkill(skill: SkillData) {
    SkillManager.instance.learnSkill(skill);
    this.close();
}
```

}`

------

### ğŸ“… å¼€å‘é˜¶æ®µäº”ï¼šæ¸¸æˆå¾ªç¯ä¸æ•°æ®æŒä¹…åŒ– (Game Loop & Persistence)

æŠŠæ‰€æœ‰æ¨¡å—ä¸²èµ·æ¥ï¼Œå¹¶ç¡®ä¿ç©å®¶é€€å‡ºæ¸¸æˆåæ•°æ®è¿˜åœ¨ã€‚

### 1. æ¸¸æˆä¸»å¾ªç¯æ§åˆ¶å™¨ (`GameManager.ts`)

è¿™æ˜¯æ¸¸æˆçš„å¤§è„‘ï¼Œæ§åˆ¶çŠ¶æ€åˆ‡æ¢ã€‚

TypeScript

`// assets/Scripts/Core/GameManager.ts import { _decorator, Component, director } from 'cc'; import { StorageManager } from './StorageManager'; const { ccclass } = _decorator;

export enum GameState { MENU, MAP, BATTLE, EVENT }

@ccclass('GameManager') export class GameManager extends Component { public static instance: GameManager;

```
public state: GameState = GameState.MENU;

onLoad() {
    GameManager.instance = this;
    director.addPersistRootNode(this.node); // è®¾ä¸ºå¸¸é©»èŠ‚ç‚¹ï¼Œåˆ‡æ¢åœºæ™¯ä¸é”€æ¯
    
    // åŠ è½½å­˜æ¡£
    StorageManager.loadGame();
}

// åˆ‡æ¢åˆ°å†’é™©æ¨¡å¼
public startAdventure(levelId: number) {
    this.state = GameState.MAP;
    // åˆå§‹åŒ–åœ°å›¾æ•°æ®...
    director.loadScene("AdventureScene");
}

// é­é‡æˆ˜æ–—
public enterBattle(enemyData: any) {
    this.state = GameState.BATTLE;
    // è¿™é‡Œæœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š
    // 1. åŠ è½½ BattleScene (é‡å‹)
    // 2. åœ¨ AdventureScene ç›´æ¥å¼¹å‡ºä¸€ä¸ªå…¨å±çš„ BattleLayer (è½»å‹ï¼ŒH5æ¨è)
    
    // å‡è®¾æˆ‘ä»¬ç”¨ Layer æ–¹å¼ï¼š
    // UIManager.showPanel("BattlePanel");
}

// æˆ˜æ–—ç»“æŸå›åˆ°åœ°å›¾
public returnToMap(victory: boolean) {
    if (victory) {
        this.state = GameState.MAP;
        // MapManager.advancePlayer(); // å°äººå¾€å‰èµ°
    } else {
        this.gameOver();
    }
    // è‡ªåŠ¨å­˜æ¡£
    StorageManager.saveGame();
}

public gameOver() {
    console.log("YOU DIED");
    // ç»“ç®—ç•Œé¢ -> å›åˆ°ä¸»èœå•
    director.loadScene("MainScene");
}
```

}`

### 2. å­˜æ¡£ç®¡ç†å™¨ (`StorageManager.ts`)

åŸºäº `localStorage` çš„ç®€å•å°è£…ã€‚

TypeScript

`// assets/Scripts/Utils/StorageManager.ts import { DataManager } from '../Core/DataManager'; import { InventoryManager } from '../Core/InventoryManager'; import { SkillManager } from '../Core/SkillManager';

const SAVE_KEY = 'PATH_OF_KINGS_SAVE_V1';

export class StorageManager {

```
static saveGame() {
    const data = {
        gold: DataManager.instance.gold,
        stats: DataManager.instance.playerStats,
        inventory: Array.from(InventoryManager.instance.slots.entries()), // Mapè½¬æ•°ç»„å­˜å‚¨
        skills: SkillManager.instance.learnedSkills.map(s => s.id), // åªå­˜ID
        // currentMapProgress: ...
    };
    
    const json = JSON.stringify(data);
    localStorage.setItem(SAVE_KEY, json);
    console.log("Game Saved!");
}

static loadGame() {
    const json = localStorage.getItem(SAVE_KEY);
    if (!json) return;

    try {
        const data = JSON.parse(json);
        
        // æ¢å¤æ•°æ®
        DataManager.instance.gold = data.gold;
        DataManager.instance.playerStats = data.stats;
        
        // æ¢å¤è£…å¤‡ (éœ€è¦æŠŠæ•°ç»„è½¬å› Map)
        if (data.inventory) {
            InventoryManager.instance.slots = new Map(data.inventory);
        }

        // æ¢å¤æŠ€èƒ½
        // SkillManager.instance.restoreSkills(data.skills);
        
        console.log("Game Loaded!");
    } catch (e) {
        console.error("Save file corrupted", e);
    }
}
```

}`